<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Quackers! 💖</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles & Variables for Celestial Dreamscape --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            height: 100%; /* Ensure html and body take full height for vh units to work correctly */
        }

        :root {
            /* Refined Soothing Celestial Dreamscape Palette */
            --color-background-start: #080818; /* Deeper, richer indigo-purple */
            --color-background-end: #03030A;   /* Even deeper, muted blue */
            --color-primary: #E6EEF5;          /* Slightly brighter, crisp off-white */
            --color-secondary: #B0C0D0;        /* Softer, elegant cool grey-blue */
            --color-accent-blue: #3A60A0;      /* More vibrant, sophisticated teal-blue */
            --color-accent-purple: #7C4DA0;    /* Deeper, more regal lavender */
            --color-gold-light: #F8E8C0;       /* Brighter, more luminous pale gold */
            --color-gold-glow: #E8D080;        /* Richer, diffused warm gold */
            --color-primary-accent: #D0E0F0;   /* Slightly more defined cool blue */

            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;

            --transition-duration-slow: 1.5s;
            --transition-duration-medium: 0.8s;
            --transition-duration-fast: 0.4s;

            /* Love Aura Colors */
            --love-aura-0: rgba(58, 96, 160, 0.1);
            --love-aura-25: rgba(58, 96, 160, 0.25);
            --love-aura-50: rgba(58, 96, 160, 0.4);
            --love-aura-75: rgba(124, 77, 160, 0.55);
            --love-aura-100: rgba(232, 208, 128, 0.8);
        }

        body {
            font-family: 'Lora', serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Segoe UI Symbol', 'Android Emoji', 'EmojiSymbols';
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto; /* Allow vertical scroll for main content */
            background: linear-gradient(165deg, var(--color-background-start), var(--color-background-end));
            background-size: 350% 350%;
            animation: cosmicGradient 180s ease infinite alternate;
            color: var(--color-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: none;
            transition: background var(--transition-duration-slow) ease-in-out;
            will-change: background-position;
        }

        /* --- Background Animations & Effects --- */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            opacity: 0.015;
            filter: blur(400px);
            z-index: -1;
            animation: nebulaDrift 200s ease-in-out infinite alternate;
            will-change: transform, opacity;
        }

        body::before {
            background: radial-gradient(circle at 90% 10%, var(--color-accent-blue), transparent);
            width: clamp(1600px, 180vw, 2800px);
            height: clamp(1600px, 180vw, 2800px);
            top: -60%;
            left: -60%;
            animation-delay: 0s;
        }

        body::after {
            background: radial-gradient(circle at 10% 90%, var(--color-accent-purple), transparent);
            width: clamp(1500px, 170vw, 2700px);
            height: clamp(1500px, 170vw, 2700px);
            bottom: -60%;
            right: -60%;
            animation-delay: 10s;
        }

        @keyframes nebulaDrift {
            0% { transform: translate(0, 0) scale(1); opacity: 0.015; }
            50% { transform: translate(250px, 120px) scale(1.15); opacity: 0.03); }
            100% { transform: translate(0, 0) scale(1); opacity: 0.015; }
        }

        @keyframes cosmicGradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* --- Text Styles --- */
        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-gold-light);
            text-align: center;
            margin-bottom: 1.2rem;
            text-shadow: 0 0 15px var(--color-gold-glow), 0 0 30px rgba(232, 208, 128, 0.6);
            word-break: break-word;
            overflow-wrap: break-word;
            animation: textSubtleShimmer 8s infinite alternate ease-in-out;
        }

        @keyframes textSubtleShimmer {
            0%, 100% { text-shadow: 0 0 15px var(--color-gold-glow), 0 0 30px rgba(232, 208, 128, 0.6); }
            50% { text-shadow: 0 0 20px var(--color-gold-glow), 0 0 40px rgba(232, 208, 128, 0.7); }
        }

        p {
            line-height: 1.8; /* Increased line height */
            text-align: center;
            color: var(--color-secondary);
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: clamp(1.0rem, 2.4vw, 1.15rem);
        }

        /* --- Utility Classes for Visibility --- */
        .hidden-element {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(40px) scale(0.95);
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
            display: none;
        }

        .active-element {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0) scale(1);
        }

        /* --- Main Content Layout --- */
        .content {
            padding: clamp(1.5rem, 5vw, 3rem);
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 5;
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out;
        }

        .content-block {
            margin-bottom: clamp(2rem, 6vw, 3rem); /* Adjusted spacing */
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out;
        }

        .gif-inline-container {
            display: flex;
            justify-content: center;
            margin: clamp(1.5rem, 5vw, 2.5rem) 0;
            width: 100%;
        }

        .gif-inline-container img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 40px var(--color-accent-blue);
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        .gif-inline-container img:hover {
            transform: scale(1.03);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7), 0 0 50px var(--color-accent-blue);
        }

        /* Enhanced .message styles */
        .message {
            background: linear-gradient(135deg, rgba(8, 8, 24, 0.8), rgba(3, 3, 10, 0.7));
            padding: clamp(1.5rem, 5vw, 2.5rem); /* Increased padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), 0 0 50px rgba(58, 96, 160, 0.6), inset 0 0 15px rgba(232, 208, 128, 0.2); /* Added inner shadow */
            border: 1px solid rgba(58, 96, 160, 0.5);
            width: 100%;
            max-width: clamp(450px, 85vw, 850px);
            margin: clamp(2rem, 6vw, 3rem) auto; /* Adjusted margin */
            font-size: clamp(1.1rem, 2.8vw, 1.4rem);
            color: var(--color-primary);
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.7), 0 0 12px rgba(232, 208, 128, 0.2); /* Enhanced text shadow */
            filter: none;
            -webkit-filter: none;
            position: relative;
            overflow: hidden;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            min-height: auto;
            height: fit-content;
            opacity: 0;
            transform: translateY(40px);
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out, box-shadow var(--transition-duration-fast) ease;
        }

        /* Animated border for .message */
        .message::before {
            content: '';
            position: absolute;
            inset: -3px; /* Border thickness */
            border-radius: var(--border-radius-lg);
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple), var(--color-gold-glow), var(--color-accent-blue));
            background-size: 300% 300%;
            animation: gradientBorder 8s linear infinite;
            z-index: -1;
            opacity: 0.7;
            filter: blur(2px);
            transition: opacity var(--transition-duration-fast) ease;
        }

        @keyframes gradientBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #messageBlock1.message {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.05rem, 2.6vw, 1.5rem);
            color: var(--color-primary);
            text-shadow: 0 0 4px rgba(0,0,0,0.3), 0 0 8px rgba(232, 208, 128, 0.1); /* Enhanced for #messageBlock1 */
            line-height: 1.8; /* Adjusted line height */
            letter-spacing: 0.02em;
            animation: messagePopOut 1.8s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 1.5s ease-out, transform 1.5s ease-out, box-shadow 0.5s ease;
            filter: none;
            -webkit-filter: none;
            white-space: pre-line; /* Use pre-line to respect newlines in JS string */
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        @keyframes messagePopOut {
            0% { opacity: 0; transform: scale(0.9) translateY(30px); }
            60% { opacity: 1; transform: scale(1.02) translateY(-8px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Enhanced hover for .message */
        .message:hover {
            transform: translateY(-4px) scale(1.005); /* Subtle lift and scale */
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 60px var(--color-accent-blue), 0 0 80px var(--color-accent-purple), inset 0 0 25px rgba(232, 208, 128, 0.4); /* More intense glow */
        }
        .message:hover::before {
            opacity: 1; /* Make border more opaque on hover */
            filter: blur(1px); /* Less blur on hover */
        }
        h1:hover { /* Keeping h1 hover separate as it's not a message box */
            box-shadow: 0 0 15px var(--color-gold-glow), 0 0 30px rgba(232, 208, 128, 0.6); /* Original h1 shadow */
        }


        /* Enhanced .message-display styles */
        .message-display {
            background: linear-gradient(135deg, rgba(8, 8, 24, 0.85), rgba(3, 3, 10, 0.75));
            padding: clamp(1.5rem, 5vw, 2.5rem); /* Increased padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.75), 0 0 45px var(--color-accent-purple), inset 0 0 12px rgba(58, 96, 160, 0.2); /* Added inner shadow */
            font-style: italic;
            font-size: clamp(1.1rem, 3.2vw, 1.4rem);
            color: var(--color-primary);
            text-shadow: 0 0 7px rgba(0,0,0,0.6), 0 0 10px rgba(58, 96, 160, 0.2); /* Enhanced text shadow */
            filter: none;
            -webkit-filter: none;
            overflow: hidden;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            min-height: auto;
            height: fit-content;
            max-width: clamp(450px, 85vw, 850px);
            position: relative; /* Needed for pseudo-element */
            transition: box-shadow var(--transition-duration-fast) ease, transform var(--transition-duration-fast) ease;
        }

        /* Animated border for .message-display */
        .message-display::before {
            content: '';
            position: absolute;
            inset: -3px; /* Border thickness */
            border-radius: var(--border-radius-lg);
            background: linear-gradient(45deg, var(--color-accent-purple), var(--color-accent-blue), var(--color-gold-light), var(--color-accent-purple));
            background-size: 300% 300%;
            animation: gradientBorder 10s linear infinite reverse; /* Slightly different animation */
            z-index: -1;
            opacity: 0.6;
            filter: blur(2px);
            transition: opacity var(--transition-duration-fast) ease;
        }

        /* Enhanced hover for .message-display */
        .message-display:hover {
            transform: translateY(-3px) scale(1.005); /* Subtle lift and scale */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 55px var(--color-accent-purple), 0 0 70px var(--color-accent-blue), inset 0 0 20px rgba(58, 96, 160, 0.4); /* More intense glow */
        }
        .message-display:hover::before {
            opacity: 1; /* Make border more opaque on hover */
            filter: blur(1px); /* Less blur on hover */
        }

        /* --- Love Meter --- */
        #loveMeter {
            background: linear-gradient(135deg, rgba(8, 8, 24, 0.85), rgba(3, 3, 10, 0.75));
            border-radius: var(--border-radius-lg);
            padding: clamp(1.8rem, 5vw, 2.8rem);
            margin-top: clamp(3rem, 7vw, 4rem); /* Adjusted spacing */
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 50px var(--color-accent-blue);
            text-align: center;
            transition: box-shadow var(--transition-duration-medium) ease-in-out, opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out;
            filter: none;
            -webkit-filter: none;
            position: relative;
        }

        #loveMeter.love-meter-pulsing {
            animation: lovePulse 2.8s infinite alternate ease-in-out;
        }

        @keyframes lovePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        #loveMeter.aura-level-1 { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 55px var(--love-aura-25); }
        #loveMeter.aura-level-2 { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 65px var(--love-aura-50); }
        #loveMeter.aura-level-3 { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 75px var(--love-aura-75); }
        #loveMeter.aura-level-4 { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 85px var(--love-aura-100), 0 0 100px var(--love-aura-100); }

        .love-meter-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            color: var(--color-gold-light);
            margin-bottom: 1.5rem;
            text-shadow: 0 0 18px var(--color-gold-glow);
            filter: none;
            -webkit-filter: none;
        }

        .ribbon-container {
            width: clamp(90%, 80vw, 600px);
            height: clamp(20px, 3vw, 26px);
            background-color: #060614;
            border-radius: 16px;
            overflow: hidden;
            margin: clamp(1.2rem, 3vw, 1.8rem) auto;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        .shimmering-ribbon {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--color-gold-glow), var(--color-gold-light), var(--color-gold-glow));
            background-size: 250% 100%;
            border-radius: 16px;
            transition: width var(--transition-duration-medium) ease-out;
            box-shadow: 0 0 18px rgba(232, 208, 128, 0.7);
            position: relative;
            z-index: 1;
        }

        .shimmering-ribbon.active-shimmer {
            animation: shimmerEffect 3s linear infinite;
        }

        @keyframes shimmerEffect {
            0% { background-position: -150% 0; }
            100% { background-position: 150% 0; }
        }

        .love-star-node {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: clamp(12px, 1.8vw, 16px);
            height: clamp(12px, 1.8vw, 16px);
            background-color: #0C0C1C;
            border-radius: 50%;
            box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
            z-index: 0;
            transition: background-color var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }
        .love-star-node.lit {
            background-color: var(--color-gold-light);
            box-shadow: 0 0 12px var(--color-gold-glow), 0 0 20px rgba(232, 208, 128, 0.6);
            animation: nodePulse 2.8s infinite alternate;
        }
        @keyframes nodePulse {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.1); }
        }

        .love-status-message {
            font-size: clamp(1.1rem, 2.8vw, 1.3rem);
            color: var(--color-secondary);
            margin-top: clamp(1.2rem, 3vw, 1.8rem);
            filter: none;
            -webkit-filter: none;
        }

        /* --- Confetti --- */
        #confettiLayer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }

        .confetti-piece {
            position: absolute;
            width: clamp(10px, 1.8vw, 14px);
            height: clamp(10px, 1.8vw, 14px);
            background-color: #f00;
            opacity: 0;
            animation: fallAndTwist 4.5s ease-out forwards;
            border-radius: 5px;
            filter: blur(0.8px);
        }

        @keyframes fallAndTwist {
            0% { transform: translateY(-15vh) rotate(0deg) scale(0.7); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(105vh) rotate(1440deg) scale(1.5); opacity: 0; }
        }

        /* --- Floating Stars (for Hug) --- */
        .floating-star-hug {
            position: fixed;
            font-size: clamp(2.5em, 6vw, 3.5em);
            opacity: 0;
            animation: floatUp 7s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 0.8; }
            80% { opacity: 0.8; }
            100% { transform: translateY(-250px); opacity: 0; }
        }

        /* --- Background Blobs (Parallax) --- */
        .background-blob {
            position: fixed;
            border-radius: 50%;
            opacity: 0.008;
            filter: blur(500px);
            z-index: 0;
            transition: transform var(--transition-duration-fast) linear;
            pointer-events: none;
            will-change: transform;
        }

        .layer-1 {
            background: radial-gradient(circle at 90% 10%, var(--color-accent-blue), transparent);
            width: clamp(1400px, 160vw, 2600px);
            height: clamp(1400px, 160vw, 2600px);
            top: -60%;
            left: -60%;
        }

        .layer-2 {
            background: radial-gradient(circle at 10% 90%, var(--color-accent-purple), transparent);
            width: clamp(1300px, 150vw, 2500px);
            height: clamp(1300px, 150vw, 2500px);
            bottom: -60%;
            right: -60%;
        }

        .layer-3 {
            background: radial-gradient(circle at 50% 50%, var(--color-gold-glow), transparent);
            width: clamp(450px, 70vw, 550px);
            height: clamp(450px, 70vw, 550px);
            top: 60%;
            left: 18%;
            transform: translateY(-50%);
        }
        .layer-4 {
            background: radial-gradient(circle at 50% 50%, var(--color-accent-blue), transparent);
            width: clamp(500px, 80vw, 600px);
            height: clamp(500px, 80vw, 600px);
            bottom: 18%;
            left: 28%;
            transform: translateX(-50%);
        }
        .layer-5 {
            background: radial-gradient(circle at 60% 40%, var(--color-primary-accent), transparent);
            width: clamp(350px, 55vw, 450px);
            height: clamp(350px, 55vw, 450px);
            top: 8%;
            right: 8%;
            opacity: 0.01;
            filter: blur(450px);
        }
        .layer-6 {
            background: radial-gradient(circle at 40% 60%, var(--color-secondary), transparent);
            width: clamp(250px, 45vw, 350px);
            height: clamp(250px, 45vw, 350px);
            bottom: 4%;
            left: 4%;
            opacity: 0.01;
            filter: blur(450px);
        }

        /* --- Particle Overlay (for general background sparkle) --- */
        #particle-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle-overlay-item {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 18s infinite ease-in-out;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.08); }
            50% { opacity: 0.6; transform: scale(1.0); }
        }

        /* --- Comet Cursor --- */
        .comet-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, var(--color-gold-light) 0%, var(--color-gold-glow) 75%, transparent 90%);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 2001;
            filter: drop-shadow(0 0 18px rgba(232, 208, 128, 0.7));
            opacity: 0;
            transition: opacity var(--transition-duration-fast) ease;
        }

        body.comet-active .comet-cursor {
            opacity: 1;
        }

        .comet-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 120px;
            background: linear-gradient(to bottom, var(--color-primary), var(--color-gold-glow), transparent);
            transform: translate(-50%, 0) rotate(45deg);
            transform-origin: top;
            filter: blur(12px);
        }

        /* --- Intro Popup --- */
        .popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            transition: opacity var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
            padding: clamp(1rem, 3vw, 2rem); /* Overall padding for the popup container */
            overflow-y: auto; /* Allow the entire popup overlay to scroll if its content is too tall */
            overflow-x: hidden;
        }

        .popup-card {
            background: linear-gradient(135deg, rgba(8, 8, 24, 0.92), rgba(3, 3, 10, 0.88));
            border-radius: var(--border-radius-lg);
            /* Increased padding to give more space around content */
            padding: clamp(2.5rem, 7vw, 4rem);
            /* Make the card wider and responsive, covering most of the screen */
            max-width: 95vw; /* Even wider */
            width: clamp(300px, 95vw, 800px); /* Responsive width, allowing it to be quite wide */
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8), 0 0 70px rgba(58, 96, 160, 0.7);
            position: relative;
            animation: popupEnter 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            cursor: pointer;
            border: 2px solid rgba(58, 96, 160, 0.6);
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
            /* Crucial: Constrain card height and enable internal scrolling */
            max-height: 95vh; /* Allow card to take up most of viewport height */
            overflow-y: auto; /* Allow content inside the card to scroll if it exceeds max-height */
            display: flex; /* Use flexbox for internal content alignment */
            flex-direction: column;
            align-items: center; /* Center items horizontally */
            justify-content: flex-start; /* Align content to the top */
            gap: clamp(1.5rem, 4vw, 2.5rem); /* Consistent spacing between elements */
        }

        @keyframes popupEnter {
            0% { transform: scale(0.15); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .popup-card:hover {
            transform: scale(1.03);
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.85), 0 0 80px rgba(58, 96, 160, 0.8);
        }

        .popup-card .gif-top {
            /* No absolute positioning here, it's part of the normal flow */
            width: clamp(90px, 18vw, 110px);
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 0 20px rgba(232, 208, 128, 0.7);
            border: 5px solid rgba(232, 208, 128, 0.7);
            animation: floatPop 4s ease-in-out infinite alternate;
            z-index: 1;
            /* Use negative margin to pull it up and overlap the top border */
            margin-top: calc(clamp(90px, 18vw, 110px) / -2); /* Half of its height pulled up */
            /* No margin-bottom here, gap property on popup-card handles spacing */
        }

        @keyframes floatPop {
            0% { transform: translateY(0); }
            50% { transform: translateY(-15px); } /* Float slightly higher */
            100% { transform: translateY(0); }
        }

        .popup-card .gif-main {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-lg);
            /* No margin-top here, gap property on popup-card handles spacing */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7), 0 0 60px rgba(232, 208, 128, 0.7);
        }

        .popup-card h2 {
            color: var(--color-gold-light);
            font-size: clamp(2.0rem, 4.5vw, 2.8rem);
            /* No margin-top or margin-bottom here, gap property on popup-card handles spacing */
            line-height: 1.5;
            text-shadow: 0 0 18px var(--color-gold-glow);
            word-break: break-word;
            overflow-wrap: break-word;
            flex-shrink: 1; /* Allow text to shrink if necessary */
        }

        .popup-card p {
            /* No margin-top or margin-bottom here, gap property on popup-card handles spacing */
            font-size: clamp(1.0rem, 2.4vw, 1.15rem);
            flex-shrink: 1; /* Allow text to shrink if necessary */
        }

        .popup-card .hint-text {
            /* No margin-top or margin-bottom here, gap property on popup-card handles spacing */
            font-size: clamp(0.9rem, 2.2vw, 1.1rem);
            opacity: 0.7;
            font-style: italic;
            flex-shrink: 1; /* Allow text to shrink if necessary */
        }

        /* --- Sparkles --- */
        .sparkle {
            position: fixed;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: sparkleTwinkle 16s infinite ease-in-out;
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 12px var(--color-gold-glow);
            width: clamp(4px, 1.2vw, 6px);
            height: clamp(4px, 1.2vw, 6px);
        }

        @keyframes sparkleTwinkle {
            0%, 100% { opacity: 0; transform: scale(0.05); }
            20%, 60% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.05); }
        }

        /* --- Screen Shake --- */
        body.screen-shaking {
            animation: shake 0.7s ease-out forwards;
            animation-iteration-count: 2;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-12px); }
            50% { transform: translateX(12px); }
            75% { transform: translateX(-12px); }
        }

        /* --- Loading Overlay --- */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--color-background-start), var(--color-background-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 1.5s ease-out, visibility 1.5s ease-out;
        }

        .loading-star-container {
            width: clamp(150px, 30vw, 250px);
            height: clamp(150px, 30vw, 250px);
            position: relative;
            margin-bottom: clamp(25px, 6vw, 50px);
        }

        .loading-star {
            width: 100%;
            height: 100%;
            background-color: var(--color-gold-light);
            position: absolute;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            opacity: 0;
            animation: starTwinkleLoad 4s ease-out forwards infinite;
            transform-origin: center;
            box-shadow: 0 0 40px var(--color-gold-glow);
        }

        @keyframes starTwinkleLoad {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            40% { transform: scale(1.4) rotate(25deg); opacity: 0.8; }
            80% { transform: scale(1.3) rotate(0deg); opacity: 0.75; }
            100% { transform: scale(0) rotate(-25deg); opacity: 0; }
        }

        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.0rem, 5vw, 3.2rem);
            color: var(--color-gold-light);
            opacity: 0;
            position: absolute;
            transform: translateY(40px);
            animation: none;
            letter-spacing: 0.07em;
            text-align: center;
            text-shadow: 0 0 18px var(--color-gold-glow);
            padding: 0 2rem;
        }
        .loading-text.active-element {
            animation: fadeInOutLoadingText 5s ease-in-out forwards;
        }

        @keyframes fadeInOutLoadingText {
            0%, 100% { opacity: 0; transform: translateY(40px); }
            25%, 75% { opacity: 1; transform: translateY(0); }
        }

        /* --- Meteor Shower --- */
        .meteor {
            position: absolute;
            background: linear-gradient(45deg, var(--color-gold-light), var(--color-gold-glow), #E8D080);
            border-radius: 50%;
            transform: rotate(45deg);
            filter: drop-shadow(0 0 18px var(--color-gold-light));
            opacity: 0.7;
            z-index: 3;
            width: clamp(8px, 1.5vw, 12px);
        }

        .meteor::after {
            content: '';
            position: absolute;
            width: clamp(12px, 2.5vw, 20px);
            height: clamp(12px, 2.5vw, 20px);
            border-radius: 50%;
            top: 90%;
            left: -8px;
            background: radial-gradient(circle, var(--color-gold-light) 0%, transparent 25%);
            box-shadow: 0 0 25px 10px rgba(232, 208, 128, 0.7);
        }

        @keyframes fall {
            0% {
                transform: translate(var(--start-x), var(--start-y)) rotate(45deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotate(45deg);
                opacity: 0;
            }
        }

        /* --- Wish Prompt --- */
        .wish-text-prompt {
            position: fixed;
            top: 18%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-gold-light);
            font-size: clamp(2.0em, 5vw, 3.2em);
            text-shadow: 0 0 20px var(--color-gold-glow), 0 0 30px var(--color-primary-accent);
            animation: floatText 6s ease-in-out infinite;
            z-index: 10;
            transition: opacity var(--transition-duration-medium) ease-in-out;
            font-family: 'Outfit', sans-serif;
            letter-spacing: 0.07em;
            text-align: center;
            white-space: normal;
            padding: 0 clamp(1.2rem, 6vw, 2rem);
        }

        @keyframes floatText {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-15px); }
        }

        /* --- Burst Particles (after meteor) --- */
        .burst-particle {
            position: absolute;
            width: clamp(8px, 1.5vw, 12px);
            height: clamp(8px, 1.5vw, 12px);
            border-radius: 50%;
            background: var(--color-gold-light);
            box-shadow: 0 0 12px 4px var(--color-gold-glow);
            opacity: 0.7;
            animation: burst 1.5s ease-out forwards;
            z-index: 5;
        }

        @keyframes burst {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(3.5); opacity: 0; }
        }

        /* --- Wishing Dust (collecting) --- */
        .wishing-dust {
            position: absolute;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: wishingDustCollect 3.5s ease-out forwards;
            box-shadow: 0 0 8px var(--color-gold-glow);
            z-index: 4;
        }
        @keyframes wishingDustCollect {
            0% { transform: translate(0, 0) scale(1); opacity: 0.7; }
            50% { transform: translate(var(--target-x), var(--target-y)) scale(1.2); opacity: 0.7; }
            100% { transform: translate(var(--target-x), var(--target-y)) scale(0.5); opacity: 0; }
        }

        /* --- Whisper Starlight Particles --- */
        .whisper-starlight-particle {
            position: fixed;
            width: clamp(4px, 1.2vw, 6px);
            height: clamp(4px, 1.2vw, 6px);
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 8px var(--color-gold-glow);
            animation: fallWhisperStarlight 4s ease-out forwards;
            z-index: 100;
            pointer-events: none;
        }

        @keyframes fallWhisperStarlight {
            0% { transform: translateY(-70px) translateX(0); opacity: 0; }
            20% { opacity: 0.7; }
            100% { transform: translateY(130vh) translateX(var(--end-x-offset, 0)); opacity: 0; }
        }

        /* --- Whisper Message Bubble --- */
        .whisper-message-bubble {
            /* This is the old dynamic bubble, keeping its style for now but it's no longer used for the main message display */
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(232, 208, 128, 0.07);
            border: 1px solid rgba(232, 208, 128, 0.2);
            color: var(--color-primary-accent);
            padding: clamp(12px, 3.5vw, 20px) clamp(20px, 6vw, 30px);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 0 15px rgba(232, 208, 128, 0.7);
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: clamp(1.1em, 2.8vw, 1.4em);
            text-align: center;
            white-space: normal;
            animation: floatUpAndFade 5s ease-out forwards;
            z-index: 101;
            pointer-events: none;
            position: relative;
            max-width: 90%;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .whisper-message-bubble::after {
            content: '';
            position: absolute;
            inset: -12px;
            border-radius: var(--border-radius-lg);
            border: 4px solid rgba(124, 77, 160, 0.5);
            opacity: 0;
            animation: auraExpandFade 3.5s ease-out forwards;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes auraExpandFade {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1.8); opacity: 0; }
        }

        @keyframes floatUpAndFade {
            0% { transform: translateX(-50%) translateY(0); opacity: 0; }
            10% { opacity: 0.7; }
            80% { opacity: 0.7; }
            100% { transform: translateX(-50%) translateY(-250px); opacity: 0; }
        }

        /* --- Magic Aura (for body) --- */
        body.magic-aura-active {
            animation: magicAura 4s ease-in-out forwards;
        }

        @keyframes magicAura {
            0% { box-shadow: inset 0 0 0px rgba(232, 208, 128, 0); }
            50% { box-shadow: inset 0 0 100px rgba(232, 208, 128, 0.5), inset 0 0 180px rgba(232, 208, 128, 0.3); }
            100% { box-shadow: inset 0 0 0px rgba(232, 208, 128, 0); }
        }

        /* --- Hover Sparkle Effect --- */
        .hover-sparkle {
            position: absolute;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: hoverSparkleFade 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 8px var(--color-gold-glow);
        }

        @keyframes hoverSparkleFade {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            20% { transform: scale(1.2) translateY(-15px); opacity: 0.7); }
            100% { transform: scale(0.5); opacity: 0; }
        }

        /* --- Wish Orb --- */
        .wish-orb {
            position: fixed;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(80px, 18vw, 100px);
            height: clamp(80px, 18vw, 100px);
            border-radius: 50%;
            background: radial-gradient(circle at 70% 30%, var(--color-gold-light), var(--color-gold-glow));
            box-shadow: 0 0 35px var(--color-gold-glow), 0 0 60px rgba(232, 208, 128, 0.7);
            opacity: 0;
            animation: wishOrbAppear 4.5s ease-out forwards;
            z-index: 10;
            pointer-events: none;
        }

        @keyframes wishOrbAppear {
            0% { opacity: 0; transform: translateX(-50%) translateY(80px) scale(0.1); }
            20% { opacity: 0.7; transform: translateX(-50%) translateY(0) scale(1.2); }
            80% { opacity: 0.7; transform: translateX(-50%) translateY(-70px) scale(1.25); animation-timing-function: ease-in-out; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-230px) scale(1.0); }
        }

        /* --- Final Message Overlay --- */
        #finalMessageOverlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, var(--color-background-start) 0%, var(--color-background-end) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 2000;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
            cursor: default;
            overflow-y: auto;
            padding-top: clamp(4rem, 7vw, 6rem);
            padding-bottom: clamp(4rem, 7vw, 6rem);
        }

        #finalMessageOverlay.active-element {
            opacity: 1;
            visibility: visible;
        }

        #finalMessageOverlay .final-message-card {
            background: linear-gradient(135deg, rgba(8, 8, 24, 0.8), rgba(3, 3, 10, 0.7));
            border-radius: var(--border-radius-lg);
            padding: clamp(3rem, 7vw, 4.5rem);
            max-width: 750px;
            width: 95%;
            text-align: center;
            box-shadow: 0 0 60px rgba(58, 96, 160, 0.6), 0 0 80px rgba(124, 77, 160, 0.4);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            margin-left: auto;
            margin-right: auto;
            animation: popupEnter 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid rgba(58, 96, 160, 0.4);
            position: relative;
            overflow: hidden;
            min-height: fit-content;
            max-height: 80vh;
        }

        .final-message-card::before, .final-message-card::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--color-gold-light) 0%, transparent 50%);
            opacity: 0.08;
            filter: blur(25px);
            pointer-events: none;
            animation: floatAndFade 30s infinite ease-in-out alternate;
        }
        .final-message-card::before {
            width: 180px; height: 180px;
            top: 2%; left: 2%;
            animation-delay: 0s;
        }
        .final-message-card::after {
            width: 200px; height: 200px;
            bottom: 4%; right: 2%;
            animation-delay: 8s;
        }
        @keyframes floatAndFade {
            0% { transform: translate(0, 0) scale(1); opacity: 0.08; }
            50% { transform: translate(25px, 20px) scale(1.08); opacity: 0.15); }
            100% { transform: translate(0, 0) scale(1); opacity: 0.08; }
        }

        #finalMessageOverlay h2 {
            font-size: clamp(3.0rem, 6.5vw, 4.5rem);
            color: var(--color-gold-light);
            text-shadow: 0 0 20px var(--color-gold-glow), 0 0 40px rgba(232, 208, 128, 0.7);
            margin-bottom: clamp(1.2rem, 3vw, 2.2rem);
            line-height: 1.1;
            letter-spacing: 0.04em;
        }

        #finalMessageOverlay p {
            font-family: 'Lora', serif;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            margin-top: clamp(1.8rem, 4vw, 3rem);
            line-height: 2.0; /* Adjusted line height */
            color: var(--color-primary);
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            text-shadow: 0 0 8px rgba(0,0,0,0.5);
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        #finalMessageOverlay .btn {
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 30px rgba(232, 208, 128, 0.7);
            font-size: clamp(1.1rem, 2.8vw, 1.4rem);
            padding: clamp(1.1rem, 3.8vw, 1.6rem) clamp(2.2rem, 6vw, 3.2rem);
            min-width: unset;
            margin-top: clamp(2.5rem, 6vw, 4rem);
        }
        #finalMessageOverlay .btn:hover {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 50px rgba(232, 208, 128, 0.8), inset 0 0 20px var(--color-gold-light);
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            transform: translateY(-4px) scale(1.04);
        }

        /* --- Music Hint --- */
        .music-hint {
            font-family: 'Lora', serif;
            font-size: clamp(0.9em, 2.2vw, 1.05em);
            color: var(--color-secondary);
            opacity: 0.75;
            margin-top: -1.5rem;
            margin-bottom: clamp(1.5rem, 3.5vw, 2.5rem);
            text-align: center;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
            padding: 0 1.2rem;
        }

        /* --- Audio Visualizer Canvas --- */
        /* Removed styles for audio visualizer as it's no longer used */

        /* Button Group specific adjustments */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Center buttons horizontally */
            gap: clamp(20px, 4vw, 30px);
            padding: clamp(1.5rem, 5vw, 2.5rem) 0;
            margin-top: clamp(2.5rem, 7vw, 4rem); /* Adjusted spacing */
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out;
        }

        .btn {
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            color: var(--color-primary);
            border: none;
            border-radius: var(--border-radius-lg);
            padding: clamp(0.9rem, 3.5vw, 1.3rem) clamp(1.8rem, 6vw, 2.5rem);
            font-family: 'Outfit', sans-serif;
            font-size: clamp(1.0rem, 2.8vw, 1.3rem);
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), 0 0 25px var(--color-accent-blue), inset 0 0 8px rgba(232, 208, 128, 0.1); /* Added inner shadow */
            transition: all var(--transition-duration-fast) ease, opacity var(--transition-duration-medium) ease;
            flex-grow: 0;
            min-width: clamp(180px, 45vw, 220px);
            max-width: clamp(300px, 45vw, 350px);
            text-shadow: 0.5px 0.5px 4px rgba(0,0,0,0.4);
            letter-spacing: 0.06em;
            position: relative;
            overflow: hidden;
            transform: scale(1);
            animation: subtleButtonGlow 4s infinite alternate ease-in-out;
            border: 1px solid transparent; /* Base transparent border for animation */
        }

        /* Animated border for buttons */
        .btn::before {
            content: '';
            position: absolute;
            inset: -2px; /* Border thickness */
            border-radius: var(--border-radius-lg);
            background: linear-gradient(45deg, var(--color-gold-light), var(--color-accent-blue), var(--color-accent-purple), var(--color-gold-light));
            background-size: 300% 300%;
            animation: gradientBorderButton 6s linear infinite;
            z-index: -1;
            opacity: 0.8;
            filter: blur(1px);
            transition: opacity var(--transition-duration-fast) ease;
        }

        @keyframes gradientBorderButton {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        @keyframes subtleButtonGlow {
            0%, 100% { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6), 0 0 25px var(--color-accent-blue), inset 0 0 8px rgba(232, 208, 128, 0.1); }
            50% { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7), 0 0 35px var(--color-accent-blue), 0 0 18px rgba(232, 208, 128, 0.3), inset 0 0 12px rgba(232, 208, 128, 0.2); }
        }

        .btn.disabled {
            opacity: 0.08;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            filter: grayscale(80%);
            animation: none;
        }
        .btn.disabled::before { /* Hide animated border when disabled */
            opacity: 0;
        }


        .btn:not(.disabled):hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 40px var(--color-accent-blue), inset 0 0 20px var(--color-gold-glow);
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            animation: starlightPulse 2.2s infinite alternate ease-in-out;
        }
        .btn:not(.disabled):hover::before {
            opacity: 1; /* Make animated border fully opaque on hover */
            filter: blur(0.5px); /* Less blur on hover */
        }
        @keyframes starlightPulse {
            0% { box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 40px var(--color-accent-blue), inset 0 0 12px var(--color-gold-glow); }
            100% { box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8), 0 0 50px var(--color-accent-blue), inset 0 0 28px var(--color-gold-glow); }
        }

        .btn:not(.disabled):active {
            transform: translateY(0) scale(0.96);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
        }

        .btn span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 500px; /* Increased size for more impact */
            height: 500px; /* Increased size for more impact */
            background: radial-gradient(circle, rgba(232, 208, 128, 0.7) 0%, transparent 70%); /* More diffused glow */
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: all 0.7s ease;
            box-shadow: 0 0 40px rgba(232, 208, 128, 0.9); /* Added glow to ripple */
        }
        .btn:active::after {
            width: 1000px; /* Even larger on active */
            height: 1000px; /* Even larger on active */
            opacity: 1;
            transition: 0s;
        }

        /* Content Sections for dynamic display */
        .content-section {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically if needed */
            width: 100%;
            margin-top: clamp(2rem, 6vw, 3rem); /* Consistent spacing */
            margin-bottom: clamp(2rem, 6vw, 3rem);
        }

        #hugGifDisplay {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6), 0 0 40px var(--color-accent-blue);
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        /* Footer Alignment */
        footer {
            width: 100%;
            text-align: center;
            padding: clamp(1.5rem, 4vw, 2.5rem);
            margin-top: clamp(3rem, 8vw, 5rem); /* Increased top margin for separation */
            color: var(--color-secondary);
            font-size: clamp(0.9rem, 2.2vw, 1.1rem);
            opacity: 0.8;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Meteor Darkening Overlay */
        #meteorDarkeningOverlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark overlay */
            backdrop-filter: blur(5px); /* Optional: subtle blur for more depth */
            -webkit-backdrop-filter: blur(5px);
            z-index: 997; /* Above content, below meteors */
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
        }
        #meteorDarkeningOverlay.active-element {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body>

    <audio id="introMusic" loop>
        <source src="music1.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="mainMusic" loop>
        <source src="music2.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="loadingOverlay" class="active-element">
        <div class="loading-star-container">
            <div class="loading-star"></div>
        </div>
        <p class="loading-text" id="loadingText1">💫 Catching constellations like whispered dreams...</p>
        <p class="loading-text" id="loadingText2">🌙 Summoning stardust secrets...</p>
        <p class="loading-text" id="loadingText3">💖 Dream-weaving your perfect little corner of the stars...</p>
    </div>

    <div id="particle-overlay"></div>

    <div class="background-blob layer-1" data-parallax-speed="0.8"></div>
    <div class="background-blob layer-2" data-parallax-speed="0.6"></div>
    <div class="background-blob layer-3" data-parallax-speed="0.4"></div>
    <div class="background-blob layer-4" data-parallax-speed="0.2"></div>
    <div class="background-blob layer-5" data-parallax-speed="0.3"></div>
    <div class="background-blob layer-6" data-parallax-speed="0.1"></div>

    <!-- Removed Audio Visualizer Canvas -->

    <div class="comet-cursor" id="cometCursor"></div>

    <div class="popup hidden-element" id="introPopup">
        <div class="popup-card" id="popupClickArea" role="button" aria-label="Click to unwrap birthday surprise">
            <!-- Dancing GIF positioned to float partially above the card -->
            <img class="gif-top" src="https://media.tenor.com/6yBqtjeP1ekAAAAj/bubu-dudu-sseeyall.gif" alt="Bubu Dudu See Ya!" loading="lazy">
            <!-- Main Birthday Cake GIF -->
            <img class="gif-main" src="https://media.tenor.com/s5AoXjOy4NsAAAAj/birthday-cake.gif" alt="Birthday Cake GIF" loading="lazy">
            <!-- Main Heading -->
            <h2>💫 Ready to float into birthday magic, Quackers? Just one tap away!</h2>
            <!-- Main Paragraph Text -->
            <p>Touch the screen and let the stars part — your dreamy birthday adventure (and Doofy) await! 🌌💫</p>
            <!-- Hint Text -->
            <p class="hint-text">Turn up the volume and let the melodies guide you... 🎶</p>
        </div>
    </div>

    <main class="content hidden-element" id="mainContent">
        <h1 class="content-block hidden-element" id="mainTitle">Happy Birthday, my dazzling duck of delight! <span aria-hidden="true">💖</span></h1>
        <p class="music-hint hidden-element" id="musicHint">🎶 Trust me — your birthday soundtrack is magical. Just listen.... �🎵</p>


        <div class="gif-inline-container content-block hidden-element" id="gifBlock1">
            <img src="https://media.tenor.com/kDB-vGnoBmUAAAAj/bubu-dudu-excited.gif" alt="Bubu Dudu Excited GIF" loading="lazy" />
        </div>

        <p class="message content-block hidden-element" id="messageBlock1"></p>

        <div class="button-group content-block hidden-element" id="chapter1ButtonGroup">
            <button id="startJourneyBtn" class="btn hidden-element"><span>🪄 Wiggle Into Wonder With Me</span></button>
        </div>

        <div id="loveMeter" class="content-block hidden-element">
            <p class="love-meter-title">🌙 Doofy’s Starry Trail of Love</p>
            <div class="ribbon-container">
                <div class="shimmering-ribbon" id="loveProgressBar"></div>
                <div class="love-star-node" style="left: 0%;" data-level="0"></div>
                <div class="love-star-node" style="left: 25%;" data-level="25"></div>
                <div class="love-star-node" style="left: 50%;" data-level="50"></div>
                <div class="love-star-node" style="left: 75%;" data-level="75"></div>
                <div class="love-star-node" style="left: 100%;" data-level="100"></div>
            </div>
            <p id="loveStatusMessage" class="love-status-message">🌙 The starlit sigh of affection waking up. (Love: <span id="loveCount">0</span>%)</p>
        </div>

        <div class="gif-inline-container content-block hidden-element" id="gifBlock2">
            <img src="https://media.tenor.com/naYMunSvaa8AAAAj/eating-cake.gif" alt="Bubu Dudu Eating Cake GIF" loading="lazy" />
        </div>

        <div class="button-group content-block hidden-element" id="chapter2ButtonGroup">
            <button id="hugBtn" class="btn hidden-element"><span>💖 Boop With Affection</span></button>
            <button id="complimentsBtn" class="btn hidden-element"><span>🪄 Cast a Flattering Spell</span></button>
        </div>

        <div class="content-section hidden-element" id="hugContentWrapper">
            <img id="hugGifDisplay" src="" alt="Hug GIF Display">
        </div>
        <div class="content-section hidden-element" id="complimentContentWrapper">
            <p class="message-display" id="complimentMessageDisplay"></p>
        </div>

        <div class="button-group content-block hidden-element" id="chapter3ButtonGroup">
            <button id="makeAWishBtn" class="btn hidden-element"><span>Cast Your Wish ✨</span></button>
        </div>

        <div class="content-section hidden-element" id="makeAWishContentWrapper">
            <p class="message-display" id="makeAWishMessage"></p>
        </div>

        <div class="button-group content-block hidden-element" id="chapter4ButtonGroup">
             <button id="whispersOfStarlightBtn" class="btn hidden-element"><span>Starlight Murmurs ✨</span></button>
        </div>

        <!-- New content section for Starlight Murmurs display -->
        <div class="content-section hidden-element" id="whisperContentWrapper">
            <p class="message-display" id="whisperMessageDisplay"></p>
        </div>

        <div class="button-group content-block hidden-element" id="finalChapterButtonGroup">
            <button id="finalMessageBtn" class="btn hidden-element disabled"><span>A Love Note, Just for You ✨❤️</span></button>
        </div>

        <footer>With all my silly love, Doofy 🐾✨</footer>
    </main>

    <div id="confettiLayer"></div>
    <div class="wish-text-prompt hidden-element" id="wishPrompt">✨ Wish upon this little spark of magic...</div>
    <div id="meteorShowerContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 998;"></div>
    <div id="whispersContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 100;"></div>
    <div id="meteorDarkeningOverlay" class="hidden-element"></div> <!-- New overlay for wish animation -->

    <div id="finalMessageOverlay" class="hidden-element">
        <div class="final-message-card">
            <h2>💫 So lucky the stars led me to you</h2>
            <p>Quackers, today the stars hum your name and the universe twirls in celebration! ✨<br><br>
Thank you for being the magic in my every day — the brilliant brain behind the plans, the soft heart that keeps me grounded, and the reason I smile like a dork. <br><br>
May your birthday bring glittery joy, surprise giggles, and all the calm your gentle heart deserves (plus a dash of chaos, because... me).<br><br>
You make the world kinder, cozy, and so wonderfully weird in all the best ways. <br><br>
Happy Birthday, my radiant duck queen 💫<br>
— Your forever Doofy 🐾💖
            </p>
            <button id="nextRealmBtn" class="btn"><span>Let's Go to the Next Realm ✨</span></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTexts = [
                document.getElementById('loadingText1'),
                document.getElementById('loadingText2'),
                document.getElementById('loadingText3')
            ];
            let currentLoadingTextIndex = 0;

            const introPopup = document.getElementById('introPopup');
            const popupClickArea = document.getElementById('popupClickArea');

            const mainContent = document.getElementById('mainContent');
            const musicHint = document.getElementById('musicHint');

            const mainTitle = document.getElementById('mainTitle');
            const gifBlock1 = document.getElementById('gifBlock1');
            const messageBlock1 = document.getElementById('messageBlock1');
            const gifBlock2 = document.getElementById('gifBlock2');

            const startJourneyBtn = document.getElementById('startJourneyBtn');
            const hugBtn = document.getElementById('hugBtn');
            const complimentsBtn = document.getElementById('complimentsBtn');
            const makeAWishBtn = document.getElementById('makeAWishBtn');
            const whispersOfStarlightBtn = document.getElementById('whispersOfStarlightBtn');
            const finalMessageBtn = document.getElementById('finalMessageBtn');
            const nextRealmBtn = document.getElementById('nextRealmBtn');

            const chapter1ButtonGroup = document.getElementById('chapter1ButtonGroup');
            const chapter2ButtonGroup = document.getElementById('chapter2ButtonGroup');
            const chapter3ButtonGroup = document.getElementById('chapter3ButtonGroup');
            const chapter4ButtonGroup = document.getElementById('chapter4ButtonGroup');
            const finalChapterButtonGroup = document.getElementById('finalChapterButtonGroup');

            const hugContentWrapper = document.getElementById('hugContentWrapper');
            const hugGifDisplay = document.getElementById('hugGifDisplay');
            const complimentContentWrapper = document.getElementById('complimentContentWrapper');
            const complimentMessageDisplay = document.getElementById('complimentMessageDisplay');
            const makeAWishContentWrapper = document.getElementById('makeAWishContentWrapper');
            const makeAWishMessage = document.getElementById('makeAWishMessage');
            const wishPrompt = document.getElementById('wishPrompt');
            const finalMessageOverlay = document.getElementById('finalMessageOverlay');
            const meteorDarkeningOverlay = document.getElementById('meteorDarkeningOverlay'); // Get the new overlay

            // New: Starlight Murmurs display elements
            const whisperContentWrapper = document.getElementById('whisperContentWrapper');
            const whisperMessageDisplay = document.getElementById('whisperMessageDisplay');

            const loveCountSpan = document.getElementById('loveCount');
            const loveProgressBar = document.getElementById('loveProgressBar');
            const loveStatusMessage = document.getElementById('loveStatusMessage');
            const loveStarNodes = document.querySelectorAll('.love-star-node');
            const confettiLayer = document.getElementById('confettiLayer');
            const particleOverlay = document.getElementById('particle-overlay');
            const loveMeterElement = document.getElementById('loveMeter');
            const meteorShowerContainer = document.getElementById('meteorShowerContainer');
            const whispersContainer = document.getElementById('whispersContainer');

            const cometCursor = document.getElementById('cometCursor');

            const introMusic = document.getElementById('introMusic');
            const mainMusic = document.getElementById('mainMusic');

            const hugGifs = [
                "https://media.tenor.com/ScOwzW70wHIAAAAj/bubu.gif",
                "https://media.tenor.com/2bw-Zzp-mTMAAAAj/bear-hug.gif",
                "https://media.tenor.com/F2SQcVd5fMIAAAAj/hug-couple.gif",
                "https://media.tenor.com/vzkveVGDzmAAAAj/dudu-hug-bubu-dudu-kiss.gif",
                "https://media.tenor.com/fFpVFqD_4esAAAAj/peluk.gif",
                "https://media.tenor.com/RG_lIajbbtQAAAAj/milk-and-mocha.gif",
                "https://media.tenor.com/YfaICXGzuSoAAAAj/i-love-you-i-missed-you.gif"
            ];

           const compliments = [
  "You make the world feel softer, just by being in it. 💖",
  "Your smile is my favorite kind of sunrise. ☀️😊",
  "You have the rare magic that turns ordinary days into something unforgettable. ✨",
  "You bring out the calm in my storms, every single time. ☀️",
  "The way you care is its own kind of beautiful. 🌸💖",
  "You make love feel like the safest, happiest place. 🏠✨",
  "You’re my favorite kind of wonder — gentle, bright, and endlessly kind. ✨🌟",
  "Being with you feels like a cozy story I never want to end.📚✨",
  "Even in silence, you say so much — and all of it feels like home. 💖✨",
  "You’re the reason ordinary moments turn into treasured memories. ❤️✨"
];

           const whisperMessages = [
  "🌙 Just your presence brings calm to the universe — and to me.",
  "💫 A starlit spell of serenity, whispered from Doofy’s heart to yours.",
  "✨ Doofy’s magic floats in — soft, sparkly, and full of quiet love.",
  "🌌 You glow brighter than constellations, and the cosmos notices. Always.",
  "✨ Wrapped in a gentle charm: peace, warmth, and a galaxy of affection from me to you.",
  "✨ A breeze of moonlight magic swirls around you — courtesy of one devoted Doofy.",
  "💖 If comfort had a name, it’d be yours — and every star agrees.",
];

            const mainStoryMessage = `Hi my dearest Quackers! 🦆💛

It’s your Doofy, sending sparkly hugs and heart-bursting affection across the stars! ✨
Like the cuddly little companions beside you, I'm absolutely *glowing* with joy to celebrate the magical soul you are.

You’re the calm in my chaos, the light in my orbit,
and the sweetest reason the universe feels warm and kind.

May your birthday be wrapped in stardust giggles, moonbeam cuddles,
and the quiet kind of joy that lingers like a melody. 💖`;

            const wishConfirmationMessage = "Your wish has taken flight on moonbeams and magic, gathering sparkle with every star it touches. 🌠 May it return to you wrapped in wonder and joy, just as you deserve.";

            let loveCount = 0;
            const maxLove = 100;
            const loveMessages = {
                0: "A tender whisper of budding affection. ✨",
                10: "A soft glow of growing fondness, a new star igniting.",
                25: "Our cherished bond begins to gracefully unfold, like a nebula taking form.",
                50: "Our connection deepens, a quiet symphony of hearts, harmonizing with the cosmos.",
                75: "The profound affection within our bond strengthens, a galaxy expanding.",
                100: "🌕 Your presence fills this space with quiet joy. (Love: 100%)"
            };

            const confettiColors = ['#E0E8F5', '#AAB7CC', '#2B4E90', '#E0C060', '#6B3A8F'];

            let hugClicked = false;
            let complimentClicked = false;
            let wishMade = false;
            let starlightWhispered = false;

            // Function to reveal an element with a fade-in and slide-up effect
            function revealElement(element, displayType = 'block', delay = 0) {
                setTimeout(() => {
                    element.style.display = displayType;
                    element.classList.remove('hidden-element');
                    element.classList.add('active-element');
                    element.style.pointerEvents = 'auto';
                }, delay);
            }

            // Function to hide an element with a fade-out and slide-down effect
            function hideElement(element) {
                element.classList.remove('active-element');
                element.classList.add('hidden-element');
                element.style.pointerEvents = 'none';
                element.addEventListener('transitionend', function handler() {
                    if (element.classList.contains('hidden-element')) {
                        element.style.display = 'none';
                    }
                    element.removeEventListener('transitionend', handler);
                }, { once: true });
            }

            // Update Love Meter Progress
            function updateLoveMeter(amount) {
                loveCount = Math.min(maxLove, loveCount + amount);
                loveCountSpan.textContent = loveCount;
                loveProgressBar.style.width = `${loveCount}%`;

                loveMeterElement.classList.remove('aura-level-1', 'aura-level-2', 'aura-level-3', 'aura-level-4');
                let auraClass = '';
                if (loveCount >= 25 && loveCount < 50) {
                    auraClass = 'aura-level-1';
                } else if (loveCount >= 50 && loveCount < 75) {
                    auraClass = 'aura-level-2';
                } else if (loveCount >= 75 && loveCount < 100) {
                    auraClass = 'aura-level-3';
                } else if (loveCount === 100) {
                    auraClass = 'aura-level-4';
                }
                if (auraClass) {
                     loveMeterElement.classList.add(auraClass);
                }

                loveStarNodes.forEach(node => {
                    const level = parseInt(node.dataset.level);
                    if (loveCount >= level) {
                        node.classList.add('lit');
                    } else {
                        node.classList.remove('lit');
                    }
                });

                if (amount > 0 && loveCount < 100) {
                    loveProgressBar.classList.add('active-shimmer');
                    createLoveDustSparkles(loveMeterElement);
                } else {
                    loveProgressBar.classList.remove('active-shimmer');
                }

                if (loveCount > 0 && loveCount < 100) {
                    loveMeterElement.classList.add('love-meter-pulsing');
                } else {
                    loveMeterElement.classList.remove('love-meter-pulsing');
                }

                let currentMessage = loveMessages[0];
                const sortedThresholds = Object.keys(loveMessages).map(Number).sort((a, b) => a - b);
                for (const threshold of sortedThresholds) {
                    if (loveCount >= threshold) {
                        currentMessage = loveMessages[threshold];
                    }
                }
                loveStatusMessage.textContent = loveCount === 100 ? loveMessages[100] : `🌼 Steady and soft, like your kindness. (Love: ${loveCount}%)`;

                if (loveCount > 0 && loveCount < 100 && amount > 0) triggerConfetti(15);
                
                // Reveal Chapter 3 and 4 buttons based on loveCount, ONLY if not already used
                if (loveCount >= 25 && chapter3ButtonGroup.classList.contains('hidden-element') && !wishMade) {
                    revealElement(chapter3ButtonGroup, 'flex');
                    revealElement(makeAWishBtn, 'block');
                }
                if (loveCount >= 50 && chapter4ButtonGroup.classList.contains('hidden-element') && !starlightWhispered) {
                    revealElement(chapter4ButtonGroup, 'flex');
                    revealElement(whispersOfStarlightBtn, 'block');
                }

                checkFinalMessageUnlock();
            }

            // Create love dust sparkles
            function createLoveDustSparkles(sourceElement) {
                const rect = sourceElement.getBoundingClientRect();
                const sparkleCount = 5;
                for (let i = 0; i < sparkleCount; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle';
                    sparkle.style.left = `${rect.left + rect.width / 2}px`;
                    sparkle.style.top = `${rect.top + rect.height / 2}px`;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    sparkle.style.animationDuration = `${Math.random() * 0.8 + 0.4}s`;
                    sparkle.style.width = `${Math.random() * 4 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.backgroundColor = 'var(--color-gold-light)';
                    sparkle.style.boxShadow = '0 0 10px var(--color-gold-glow)';
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }

            // Trigger confetti animation
            function triggerConfetti(count = 30) {
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = `${-10 - Math.random() * 20}vh`;
                    confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    confetti.style.animationDelay = Math.random() * 0.6 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 4) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                    confettiLayer.appendChild(confetti);
                    confetti.addEventListener('animationend', () => confetti.remove());
                }
            }

            // Create floating stars for hug effect
            function createFloatingStar() {
                const star = document.createElement('div');
                star.className = 'floating-star-hug';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.animationDuration = (Math.random() * 3 + 7) + 's';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.textContent = '⭐';
                document.body.appendChild(star);
                star.addEventListener('animationend', () => star.remove());
            }

            // Trigger whispers of starlight effect
            function triggerWhispersOfStarlight(message) {
                document.body.classList.add('magic-aura-active');
                setTimeout(() => {
                    document.body.classList.remove('magic-aura-active');
                }, 3000);

                const particleCount = 40;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'whisper-starlight-particle';
                    const size = Math.random() * 3 + 1;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.animationDelay = `${Math.random() * 1.8}s`;
                    particle.style.animationDuration = `${Math.random() * 1.8 + 2.5}s`;
                    particle.style.setProperty('--end-x-offset', `${(Math.random() - 0.5) * 60}px`);
                    whispersContainer.appendChild(particle);
                    particle.addEventListener('animationend', () => particle.remove());
                }

                // Removed dynamic whisper-message-bubble creation
                // The message is now displayed in the static whisperMessageDisplay element
            }

            // Hide all content display areas (not button groups)
            function hideAllContentDisplayAreas() {
                hideElement(hugContentWrapper);
                hideElement(complimentContentWrapper);
                hideElement(makeAWishContentWrapper);
                hideElement(whisperContentWrapper); // Added for the new static whisper display
            }

            // Trigger meteor shower effect
            function triggerMeteorShower(count = 70, duration = 6000) {
                document.body.classList.add('screen-shaking');
                revealElement(wishPrompt, 'block');
                revealElement(meteorDarkeningOverlay); // Reveal the new overlay

                for (let i = 0; i < count; i++) {
                    const meteor = document.createElement('div');
                    meteor.className = 'meteor';

                    const startX = window.innerWidth * (0.8 + Math.random() * 0.4);
                    const startY = -window.innerHeight * (0.1 + Math.random() * 0.2);
                    const endX = -window.innerWidth * (0.2 + Math.random() * 0.4);
                    const endY = window.innerHeight * (1.1 + Math.random() * 0.2);

                    const size = Math.random() * 4 + 4;
                    meteor.style.width = `${size}px`;
                    meteor.style.height = `${size * 40}px`;

                    meteor.style.setProperty('--start-x', `${startX}px`);
                    meteor.style.setProperty('--start-y', `${startY}px`);
                    meteor.style.setProperty('--end-x', `${endX}px`);
                    meteor.style.setProperty('--end-y', `${endY}px`);

                    const animDuration = 4 + Math.random() * 3;
                    meteor.style.animation = `fall ${animDuration}s cubic-bezier(0.4, 0, 0.6, 1) forwards`;
                    meteor.style.animationDelay = `${Math.random() * (duration / 1000) * 0.8}s`;

                    meteorShowerContainer.appendChild(meteor);

                    meteor.addEventListener('animationend', () => {
                        const meteorRect = meteor.getBoundingClientRect();
                        if (meteorRect.right > -50 && meteorRect.bottom > -50 && meteorRect.left < window.innerWidth + 50 && meteorRect.top < window.innerHeight + 50) {
                             createBurst(meteorRect.right, meteorRect.bottom);
                             createWishingDust(meteorRect.right, meteorRect.bottom);
                        }
                        meteor.remove();
                    }, { once: true });
                }

                setTimeout(() => {
                    document.body.classList.remove('screen-shaking');
                    hideElement(wishPrompt);
                    hideElement(meteorDarkeningOverlay); // Hide the new overlay
                    createWishOrb();
                    makeAWishMessage.textContent = wishConfirmationMessage; // Directly set text
                }, duration + 1000);
            }

            // Create burst particles
            function createBurst(x, y) {
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'burst-particle';
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * 40;
                    const dx = Math.cos(angle) * radius;
                    const dy = Math.sin(angle) * radius;
                    particle.style.left = `${x + dx}px`;
                    particle.style.top = `${y + dy}px`;
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }
            }

            // Create wishing dust particles
            function createWishingDust(x, y, count = 8) {
                const targetX = window.innerWidth / 2;
                const targetY = window.innerHeight * 0.8;
                for (let i = 0; i < count; i++) {
                    const dust = document.createElement('div');
                    dust.className = 'wishing-dust';
                    const size = Math.random() * 4 + 2;
                    dust.style.width = `${size}px`;
                    dust.style.height = `${size}px`;
                    dust.style.left = `${x + (Math.random() - 0.5) * 20}px`;
                    dust.style.top = `${y + (Math.random() - 0.5) * 20}px`;
                    dust.style.animationDelay = `${Math.random() * 0.2}s`;
                    dust.style.setProperty('--target-x', `${targetX - dust.getBoundingClientRect().left}px`);
                    dust.style.setProperty('--target-y', `${targetY - dust.getBoundingClientRect().top}px`);
                    document.body.appendChild(dust);
                    dust.addEventListener('animationend', () => dust.remove());
                }
            }

            // Create wish orb
            function createWishOrb() {
                const orb = document.createElement('div');
                orb.className = 'wish-orb';
                document.body.appendChild(orb);
                orb.addEventListener('animationend', () => orb.remove());
            }

            // Setup parallax for background blobs
            function setupParallax() {
                const parallaxLayers = document.querySelectorAll('.background-blob');
                window.addEventListener('scroll', () => {
                    const scrollY = window.pageYOffset;
                    parallaxLayers.forEach(layer => {
                        const speed = parseFloat(layer.dataset.parallaxSpeed);
                        const transformY = -scrollY * speed * 0.1;
                        layer.style.transform = `translateY(${transformY}px)`;
                    });
                });
            }

            // Create background particles
            function createParticles(count) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle-overlay-item';
                    particle.style.width = `${Math.random() * 4 + 1}px`;
                    particle.style.height = particle.style.width;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.top = `${Math.random() * 100}vh`;
                    particle.style.animationDelay = `${Math.random() * 15}s`;
                    particle.style.animationDuration = `${Math.random() * 7 + 10}s`;
                    particleOverlay.appendChild(particle);
                }
            }

            // Handle comet cursor movement
            document.addEventListener("mousemove", (e) => {
                cometCursor.style.left = `${e.clientX}px`;
                cometCursor.style.top = `${e.clientY}px`;
                if (!document.body.classList.contains('comet-active')) {
                    document.body.classList.add('comet-active');
                }
            });

            // Create hover sparkles on elements
            function createHoverSparkles(event) {
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const numSparkles = 5;
                for (let i = 0; i < numSparkles; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle';
                    sparkle.style.left = `${rect.left + Math.random() * rect.width}px`;
                    sparkle.style.top = `${rect.top + Math.random() * rect.height}px`;
                    sparkle.style.width = `${Math.random() * 3 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }

            // Orchestrates content visibility during effects (meteor shower, whispers)
            function manageContentVisibilityForEffect(effectFn, effectDuration, callbackAfterEffect = () => {}) {
                hideAllContentDisplayAreas();

                setTimeout(() => {
                    effectFn();
                    
                    setTimeout(() => {
                        // After effect, reveal the wrapper and ensure content is visible
                        if (makeAWishMessage.textContent.trim() !== "") {
                            revealElement(makeAWishContentWrapper, 'flex');
                        }
                        if (whisperMessageDisplay.textContent.trim() !== "") { // New: reveal whisper box
                            revealElement(whisperContentWrapper, 'flex');
                        }
                        
                        updateLoveMeter(0);
                        callbackAfterEffect();
                    }, effectDuration);
                }, 700);
            }

            // Check if final message can be unlocked
            function checkFinalMessageUnlock() {
                if (hugClicked && complimentClicked && wishMade && starlightWhispered) {
                    if (loveCount < 100) {
                        loveCount = 100;
                        updateLoveMeter(0);
                    }

                    if (finalMessageBtn.classList.contains('disabled')) {
                        finalMessageBtn.classList.remove('disabled');
                        revealElement(finalChapterButtonGroup, 'flex');
                        revealElement(finalMessageBtn, 'block');
                    }
                }
            }

            // Start loading screen storytelling
            function startLoadingStorytelling() {
                // Start intro music immediately
                introMusic.play().catch(e => console.log("Intro music playback prevented:", e));

                function showNextLoadingText() {
                    if (currentLoadingTextIndex < loadingTexts.length) {
                        const currentText = loadingTexts[currentLoadingTextIndex];
                        currentText.classList.add('active-element');
                        currentText.addEventListener('animationend', () => {
                            currentText.classList.remove('active-element');
                            currentLoadingTextIndex++;
                            showNextLoadingText();
                        }, { once : true });
                    } else {
                        setTimeout(() => {
                            hideElement(loadingOverlay);
                            loadingOverlay.addEventListener('transitionend', () => {
                                loadingOverlay.remove();
                            }, { once: true });
                            // Reveal intro popup after loading
                            revealElement(introPopup, 'flex');
                        }, 500);
                    }
                }
                showNextLoadingText();
            }

            // Event listener for intro popup click
            popupClickArea.addEventListener('click', () => {
                hideElement(introPopup);

                // Pause intro music and play main music
                introMusic.pause();
                introMusic.currentTime = 0;
                mainMusic.play().catch(e => console.log("Main music playback prevented:", e));
                

                introPopup.addEventListener('transitionend', () => {
                    // Directly set the main story message
                    messageBlock1.textContent = mainStoryMessage;
                    revealElement(chapter1ButtonGroup, 'flex');
                    revealElement(startJourneyBtn, 'block');

                    revealElement(mainContent, 'block');
                    revealElement(mainTitle, 'block', 300);
                    revealElement(musicHint, 'block', 600);
                    revealElement(gifBlock1, 'flex', 900);
                    revealElement(messageBlock1.closest('.content-block'), 'block', 1200);

                    setTimeout(() => {
                        for(let i = 0; i < 40; i++) {
                            const s = document.createElement('div');
                            s.className = 'sparkle';
                            s.style.left = Math.random() * 100 + 'vw';
                            s.style.top = Math.random() * 100 + 'vh';
                            s.style.animationDelay = Math.random() * 8 + 's';
                            document.body.appendChild(s);
                        }
                    }, 1000);
                }, { once : true });
            });

            // Initial setup on window load
            window.addEventListener('load', () => {
                startLoadingStorytelling();
            });

            // Event listener for Start Journey button
            startJourneyBtn.addEventListener('click', () => {
                hideElement(startJourneyBtn);
                hideElement(chapter1ButtonGroup);
                hideElement(gifBlock1);

                setTimeout(() => {
                    revealElement(loveMeterElement, 'block');
                }, 500);

                setTimeout(() => {
                    revealElement(gifBlock2, 'flex');
                }, 1000);

                setTimeout(() => {
                    revealElement(chapter2ButtonGroup, 'flex');
                    revealElement(hugBtn, 'block');
                    revealElement(complimentsBtn, 'block');
                }, 1500);
            });

            // Event listener for Hug button
            hugBtn.addEventListener('click', () => {
                hideAllContentDisplayAreas();
                
                const randomGif = hugGifs[Math.floor(Math.random() * hugGifs.length)];
                hugGifDisplay.src = randomGif;
                revealElement(hugContentWrapper, 'flex');
                
                if (!hugClicked) {
                    hugClicked = true;
                    updateLoveMeter(10);
                }
                for(let i = 0; i < 5; i++) createFloatingStar();
            });

            // Event listener for Compliments button
            complimentsBtn.addEventListener('click', () => {
                hideAllContentDisplayAreas();
                
                complimentMessageDisplay.textContent = compliments[Math.floor(Math.random() * compliments.length)]; // Directly set text
                revealElement(complimentContentWrapper, 'flex');

                if (!complimentClicked) {
                    complimentClicked = true;
                    updateLoveMeter(15);
                }
            });

            // Event listener for Make a Wish button
            makeAWishBtn.addEventListener('click', () => {
                if (wishMade) {
                    return;
                }
                
                messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'start' });

                manageContentVisibilityForEffect(
                    () => {
                        triggerMeteorShower(70, 5000);
                    },
                    6500,
                    () => {
                        revealElement(makeAWishContentWrapper, 'flex');
                        wishMade = true;
                        hideElement(chapter3ButtonGroup);
                        updateLoveMeter(25);
                    }
                );
            });

            // Event listener for Whispers of Starlight button
            whispersOfStarlightBtn.addEventListener('click', () => {
                if (starlightWhispered) {
                    return;
                }
                
                messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'start' });

                manageContentVisibilityForEffect(
                    () => {
                        const randomMessage = whisperMessages[Math.floor(Math.random() * whisperMessages.length)];
                        whisperMessageDisplay.textContent = randomMessage; // Set text to the new static element
                        triggerWhispersOfStarlight(randomMessage); // Still trigger particles/aura
                    },
                    4500,
                    () => {
                        revealElement(whisperContentWrapper, 'flex'); // Reveal the new static element's wrapper
                        starlightWhispered = true;
                        hideElement(chapter4ButtonGroup);
                        triggerConfetti(30);
                        updateLoveMeter(30);
                    }
                );
            });

            // Event listener for Final Message button
            finalMessageBtn.addEventListener('click', () => {
                hideElement(mainContent);
                
                window.scrollTo({
                    top: 0,
                    behavior: 'instant'
                });

                mainContent.addEventListener('transitionend', () => {
                    revealElement(finalMessageOverlay, 'flex');
                    // Ensure mainMusic is playing if it wasn't already (e.g., if user paused it)
                    if (mainMusic.paused) {
                        mainMusic.play().catch(e => console.log("Main music playback prevented on final screen:", e));
                    }
                    document.body.classList.add('comet-active');
                }, { once : true });
            });

            // Event listener for Next Realm button
            nextRealmBtn.addEventListener('click', () => {
                window.location.href = 'netflix.html';
            });

            // Add hover sparkles to interactive elements
            const elementsWithHoverSparkles = [mainTitle, messageBlock1, loveMeterElement];
            elementsWithHoverSparkles.forEach(el => {
                el.addEventListener('mouseenter', createHoverSparkles);
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mouseenter', createHoverSparkles);
            });

            // Initial setup calls
            setupParallax();
            createParticles(200);
            updateLoveMeter(0);
        });
    </script>
</body>
</html>
