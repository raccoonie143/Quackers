<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Quackers! üíñ</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Moonlight & Gold Palette */
            --color-primary: #f0f0f0; /* Soft White */
            --color-secondary: #c0c0c0; /* Light Gray */
            --color-background-start: #08081a; /* Deeper Midnight Blue */
            --color-background-end: #000000; /* Pure Black */
            --color-text-dark: #333;
            --color-accent-blue: #5a70e0; /* Soft Lavender Blue */
            --color-accent-purple: #e07390; /* Muted Rose Pink */
            --color-gold-light: #fffacd; /* Luminous Gold */
            --color-gold-glow: #ffcc33; /* Stronger Gold for glow */
            --color-primary-accent: #e0e0e0; /* Modern metallic */
            --color-midnight-blue: #1a2a4a; /* Midnight Blue for elements */

            /* Sizes */
            --border-radius-sm: 10px; /* Slightly increased */
            --border-radius-md: 15px; /* Slightly increased */
            --border-radius-lg: 25px; /* Slightly increased */

            /* Animation */
            --transition-duration-slow: 1.0s; /* Slower for more elegance */
            --transition-duration-medium: 0.7s;
            --transition-duration-fast: 0.4s;
            --stagger-unit: 0.1s; /* Faster staggering for quicker reveals */
            --typewriter-char-delay: 0.02s; /* Faster character typing */

            /* Dynamic Love Meter Aura Colors */
            --love-aura-0: rgba(90, 112, 224, 0.4); /* Soft Lavender Blue */
            --love-aura-25: rgba(90, 112, 224, 0.6);
            --love-aura-50: rgba(90, 112, 224, 0.8);
            --love-aura-75: rgba(224, 115, 144, 0.9); /* Shifting to Rose Pink */
            --love-aura-100: rgba(255, 204, 51, 0.9); /* Gold at full */
        }

        /* --- General Styles --- */
        body {
            font-family: 'Lora', serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            background: linear-gradient(135deg, var(--color-background-start), var(--color-background-end));
            background-size: 200% 200%;
            animation: cosmicGradient 60s ease infinite alternate; /* Slower, smoother animation */
            color: var(--color-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: none; /* Hide default cursor */
            transition: background var(--transition-duration-slow) ease-in-out;
            will-change: background-position;
        }

        /* Deeper Celestial Background: Nebula Effect */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            opacity: 0.15;
            filter: blur(180px); /* Increased blur */
            z-index: -1;
            animation: nebulaDrift 80s ease-in-out infinite alternate;
            will-change: transform, opacity;
        }

        body::before {
            background: radial-gradient(circle at 70% 30%, var(--color-accent-blue), transparent);
            width: 1300px; /* Larger */
            height: 1300px;
            top: -250px; /* Shifted */
            left: -350px; /* Shifted */
            animation-delay: 0s;
        }

        body::after {
            background: radial-gradient(circle at 30% 70%, var(--color-accent-purple), transparent);
            width: 1100px; /* Larger */
            height: 1100px;
            bottom: -250px; /* Shifted */
            right: -350px; /* Shifted */
            animation-delay: 5s;
        }

        @keyframes nebulaDrift {
            0% { transform: translate(0, 0) scale(1); opacity: 0.15; }
            50% { transform: translate(120px, 60px) scale(1.06); opacity: 0.2; } /* Slightly more movement */
            100% { transform: translate(0, 0) scale(1); opacity: 0.15; }
        }

        @keyframes cosmicGradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-gold-light);
            text-align: center;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 12px var(--color-gold-glow), 0 0 25px rgba(255, 204, 51, 0.5); /* Stronger glow */
        }

        p {
            line-height: 1.7;
            text-align: center;
            color: var(--color-secondary);
        }

        /* Utility classes for hidden/active states */
        .hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(30px); /* More pronounced translateY */
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out, visibility var(--transition-duration-slow) ease-out;
        }

        .active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
        }

        .content {
            padding: 2rem;
            box-sizing: border-box;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 5;
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
        }

        .content-block {
            margin-bottom: 1.8rem;
            filter: blur(8px); /* Initial blur for reveal */
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out, filter var(--transition-duration-slow) ease-out;
        }

        .content-block.active {
            filter: blur(0);
        }

        .gif-inline-container {
            display: flex;
            justify-content: center;
            margin: 2.2rem 0; /* Slightly more margin */
        }

        .gif-inline-container img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 40px var(--color-accent-blue); /* Stronger, softer shadow */
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        .gif-inline-container img:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), 0 0 50px var(--color-accent-blue);
        }

        .message {
            background: linear-gradient(135deg, rgba(10, 20, 50, 0.45), rgba(0, 0, 0, 0.35)); /* Gradient background */
            padding: 2rem; /* Increased padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 45px rgba(106, 130, 251, 0.4); /* Stronger, softer shadow */
            border: 1px solid rgba(106, 130, 251, 0.4); /* Softer border */
            max-width: 750px; /* Slightly wider */
            margin: 2.5rem auto; /* More margin */
            font-size: clamp(0.95rem, 2.5vw, 1.15rem); /* Adjusted font size */
            color: var(--color-secondary);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px); /* Increased blur */
            -webkit-backdrop-filter: blur(6px);
            position: relative;
            overflow: hidden; /* Crucial for typewriter effect */
            /* Removed initial visibility: hidden here. Managed by .hidden/.active classes on content-block parent. */
            white-space: pre-wrap; /* Ensure newlines are preserved */
            text-align: center;
            min-height: 150px; /* Ensure message block has space even if empty */
            display: flex; /* To vertically center typed text if needed */
            align-items: center; /* Vertically center */
            justify-content: center; /* Horizontally center */
        }

        /* Cosmic Calligraphy: Text glow on reveal */
        .message span {
            opacity: 0;
            animation: textFadeInGlow 0.9s forwards; /* Slower animation */
            animation-timing-function: cubic-bezier(0.2, 0.8, 0.4, 1.2);
            display: inline-block; /* Essential for span animation */
            text-shadow: none; /* Reset default text-shadow */
            white-space: pre-wrap; /* Preserve spaces and line breaks for proper typing */
            color: var(--color-primary); /* Ensure text color is primary */
            font-weight: 400; /* Normal weight for body text */
        }

        @keyframes textFadeInGlow {
            0% { opacity: 0; transform: translateY(8px); text-shadow: 0 0 0px var(--color-gold-glow); }
            50% { opacity: 1; transform: translateY(0); text-shadow: 0 0 10px var(--color-gold-glow); }
            100% { opacity: 1; text-shadow: 0 0 0px var(--color-gold-glow); }
        }

        /* Hover aura for message/text elements */
        .message:hover, h1:hover {
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 50px var(--color-accent-blue), 0 0 70px var(--color-accent-purple); /* Stronger glow */
            transition: box-shadow var(--transition-duration-fast) ease;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px; /* Increased gap */
            padding: 2rem 0; /* Increased padding */
            margin-top: 2.5rem; /* Increased margin */
            transition: opacity var(--transition-duration-slow) ease-out;
        }

        .btn {
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            color: var(--color-primary);
            border: none;
            border-radius: var(--border-radius-lg);
            padding: 1.1rem 2.2rem; /* Slightly more padding */
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.95rem, 2.5vw, 1.15rem); /* Adjusted font size */
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 30px var(--color-accent-blue); /* Stronger shadow */
            transition: all var(--transition-duration-fast) ease, opacity var(--transition-duration-medium) ease;
            flex-grow: 1;
            min-width: 220px; /* Slightly wider */
            max-width: 300px; /* Slightly wider */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn.disabled {
            opacity: 0.4; /* Slightly more transparent */
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            filter: grayscale(80%);
        }

        /* Starlight Pulse: Button border glow */
        .btn:not(.disabled):hover {
            transform: translateY(-5px) scale(1.03); /* More pronounced lift */
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 40px var(--color-accent-blue), inset 0 0 20px var(--color-gold-glow); /* Inset glow */
            background: linear-gradient(45deg, #7b92ff, #ff6a8b);
            animation: starlightPulse 1.8s infinite alternate ease-in-out; /* Slower pulse */
        }
        @keyframes starlightPulse {
            0% { box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 40px var(--color-accent-blue), inset 0 0 8px var(--color-gold-glow); }
            100% { box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 50px var(--color-accent-blue), inset 0 0 25px var(--color-gold-glow); }
        }

        .btn:not(.disabled):active {
            transform: translateY(0) scale(0.97); /* More pronounced press */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .btn span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Slightly more gap */
            position: relative;
            z-index: 1;
        }

        /* Subtle Inner Aura (On Click) */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px; /* Larger initial size */
            height: 8px;
            background: rgba(255, 204, 51, 0.4); /* Gold-toned ripple */
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease; /* Slower transition */
        }
        .btn:active::after {
            width: 250px; /* Larger ripple */
            height: 250px;
            opacity: 1;
            transition: 0s;
        }

        footer {
            margin-top: 3rem; /* More space */
            padding: 2.5rem; /* More padding */
            color: var(--color-secondary);
            font-family: 'Lora', serif;
            font-size: 0.95em;
            text-align: center;
            opacity: 0.8;
            z-index: 5;
            position: relative;
        }

        /* --- Content Sections (Initially Hidden) --- */
        .content-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 1.8rem; /* Adjusted for closer proximity to buttons/text */
            margin-bottom: 2rem; /* Ensure space below */
            padding: 0 1.2rem;
            box-sizing: border-box;
            max-width: 900px; /* Constrain width */
            margin-left: auto;
            margin-right: auto;
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
        }

        #hugGifDisplay {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 40px var(--color-accent-purple);
            margin-bottom: 0.8rem; /* Closer to text if any below */
        }

        .message-display {
            background: linear-gradient(135deg, rgba(10, 20, 50, 0.55), rgba(0, 0, 0, 0.45)); /* Gradient background */
            padding: 1.8rem; /* Increased padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6), 0 0 35px var(--color-accent-purple);
            font-style: italic;
            font-size: clamp(1.05rem, 3vw, 1.25rem); /* Adjusted font size */
            color: var(--color-primary);
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            overflow: hidden; /* Crucial for typewriter effect */
            /* Removed initial visibility: hidden here. Managed by .hidden/.active classes on content-block parent. */
            white-space: pre-wrap; /* Ensure newlines are preserved */
            text-align: center;
            min-height: 100px; /* Ensure it has space */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .message-display span {
            opacity: 0;
            animation: textFadeInGlow 0.9s forwards; /* Slower animation */
            animation-timing-function: cubic-bezier(0.2, 0.8, 0.4, 1.2);
            display: inline-block;
            text-shadow: none;
            white-space: pre-wrap;
            color: var(--color-primary); /* Ensure text color is primary */
        }


        /* --- Love Meter (Golden Thread of Light) --- */
        #loveMeter {
            background: linear-gradient(135deg, rgba(20, 30, 60, 0.65), rgba(0, 0, 0, 0.55)); /* Gradient background */
            border-radius: var(--border-radius-lg);
            padding: 2rem; /* Increased padding */
            margin-top: 2.5rem; /* More margin */
            box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 40px var(--color-accent-blue); /* Stronger, softer shadow */
            text-align: center;
            transition: box-shadow var(--transition-duration-medium) ease-in-out, opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
            backdrop-filter: blur(8px); /* Increased blur */
            -webkit-backdrop-filter: blur(8px);
            position: relative;
        }

        #loveMeter.love-meter-pulsing {
            animation: lovePulse 1.8s infinite alternate ease-in-out; /* Slower pulse */
        }

        @keyframes lovePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.015); } /* Slightly more noticeable pulse */
        }

        /* Love Meter Aura based on fill percentage (Dynamic in JS) */
        #loveMeter.aura-level-1 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 45px var(--love-aura-25); } /* Increased glow */
        #loveMeter.aura-level-2 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 55px var(--love-aura-50); }
        #loveMeter.aura-level-3 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 65px var(--love-aura-75); }
        #loveMeter.aura-level-4 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 75px var(--love-aura-100), 0 0 100px var(--love-aura-100); } /* Strongest glow */


        .love-meter-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.5rem, 3.5vw, 2.1rem); /* Adjusted font size */
            color: var(--color-gold-light);
            margin-bottom: 1.2rem;
            text-shadow: 0 0 12px var(--color-gold-glow);
        }

        .ribbon-container {
            width: 85%; /* Slightly wider */
            max-width: 550px;
            height: 22px; /* Slightly taller */
            background-color: #3a3a5a;
            border-radius: 12px; /* Smoother corners */
            overflow: hidden;
            margin: 1.2rem auto;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.6); /* Deeper inset shadow */
            position: relative;
        }

        .shimmering-ribbon {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ffcc33, #ffd700, #fffa8c, #ffd700, #ffcc33);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width var(--transition-duration-medium) ease-out;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.9); /* Stronger shimmer glow */
            position: relative;
            z-index: 1; /* Above nodes */
        }

        .shimmering-ribbon.active-shimmer {
            animation: shimmerEffect 2.5s linear infinite; /* Slower shimmer */
        }

        @keyframes shimmerEffect {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        /* Golden Thread: Love Star Nodes */
        .love-star-node {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 14px; /* Larger nodes */
            height: 14px;
            background-color: #555; /* Unlit color */
            border-radius: 50%;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.6);
            z-index: 0; /* Below ribbon */
            transition: background-color var(--transition-duration-medium) ease, box-shadow var(--transition-duration-medium) ease;
        }
        .love-star-node.lit {
            background-color: var(--color-gold-light);
            box-shadow: 0 0 12px var(--color-gold-glow), 0 0 25px rgba(255, 204, 51, 0.6); /* Stronger glow */
            animation: nodePulse 1.8s infinite alternate; /* Slower pulse */
        }
        @keyframes nodePulse {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.15); } /* Slightly more pronounced pulse */
        }

        .love-status-message {
            font-size: clamp(1.05rem, 2.5vw, 1.15rem); /* Adjusted font size */
            color: var(--color-secondary);
            margin-top: 1.2rem;
        }

        /* --- Confetti --- */
        #confettiLayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }

        .confetti-piece {
            position: absolute;
            width: 10px; /* Slightly larger */
            height: 10px;
            background-color: #f00; /* Default, will be overridden by JS */
            opacity: 0;
            animation: fallAndTwist 3.5s ease-out forwards; /* Slower fall */
            border-radius: 3px; /* Slightly more rounded */
            filter: blur(0.7px); /* Slightly more blur */
        }

        @keyframes fallAndTwist {
            0% { transform: translateY(-10vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(1); opacity: 0; }
        }

        /* --- Floating Stars for Hug Button --- */
        .floating-star-hug {
            position: fixed;
            font-size: 2.8em; /* Larger stars */
            opacity: 0;
            animation: floatUp 5.5s ease-out forwards; /* Slower float */
            pointer-events: none;
            z-index: 10;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-180px); opacity: 0; } /* Floats higher */
        }

        /* --- Background Blobs (Parallax) --- */
        .background-blob {
            position: fixed;
            border-radius: 50%;
            opacity: 0.6;
            filter: blur(120px); /* Increased blur */
            z-index: 0; /* Behind everything */
            transition: transform var(--transition-duration-fast) linear;
            pointer-events: none;
            will-change: transform;
        }

        .layer-1 {
            background-color: rgba(90, 112, 224, 0.25); /* Slightly more opaque */
            width: 650px; /* Larger */
            height: 650px;
            top: -120px;
            left: -120px;
        }

        .layer-2 {
            background-color: rgba(224, 115, 144, 0.25);
            width: 850px;
            height: 850px;
            bottom: -220px;
            right: -220px;
        }

        .layer-3 {
            background-color: rgba(255, 204, 51, 0.2); /* Slightly more opaque */
            width: 450px;
            height: 450px;
            top: 50%;
            left: 12%; /* Shifted */
            transform: translateY(-50%);
        }
        .layer-4 {
            background-color: rgba(90, 112, 224, 0.2);
            width: 550px;
            height: 550px;
            bottom: 12%; /* Shifted */
            left: 22%; /* Shifted */
            transform: translateX(-50%);
        }

        /* --- Particle Overlay (Stardust) --- */
        #particle-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle-overlay-item {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9); /* Brighter */
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 12s infinite ease-in-out; /* Slower twinkle */
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.6); /* Stronger glow */
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.6); }
            50% { opacity: 0.9; transform: scale(1.1); } /* More pronounced twinkle */
        }

        /* --- Comet Cursor --- */
        .comet-cursor {
            position: fixed;
            width: 35px; /* Larger */
            height: 35px;
            background: radial-gradient(circle, #ffe17b 0%, #ffcc33 50%, transparent 80%);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 1000;
            filter: drop-shadow(0 0 18px rgba(255, 204, 51, 0.9)); /* Stronger glow */
            opacity: 0;
            transition: opacity var(--transition-duration-medium) ease;
        }

        body.comet-active .comet-cursor {
            opacity: 1;
        }

        .comet-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 3px; /* Wider tail */
            height: 90px; /* Longer tail */
            background: linear-gradient(to bottom, #fffae0, #ffcc33, transparent);
            transform: translate(-50%, 0) rotate(45deg);
            transform-origin: top;
            filter: blur(12px); /* More blur */
        }

        /* --- Popup Styles --- */
        .popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85); /* Slightly darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(12px); /* Increased blur */
            -webkit-backdrop-filter: blur(12px);
            transition: opacity var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
        }

        .popup-card {
            background: linear-gradient(135deg, rgba(20, 30, 60, 0.98), rgba(0, 0, 0, 0.95)); /* Darker, more prominent gradient */
            border-radius: var(--border-radius-lg);
            padding: 2.8rem; /* Increased padding */
            max-width: 550px; /* Wider */
            width: 92%; /* Wider on smaller screens */
            text-align: center;
            box-shadow: 0 12px 45px rgba(0, 0, 0, 0.9), 0 0 60px rgba(106, 130, 251, 0.8); /* Stronger, more diffused shadow */
            position: relative;
            animation: popupEnter 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Slower, bouncier entry */
            cursor: pointer;
            border: 2px solid rgba(106, 130, 251, 0.7); /* Stronger border */
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        @keyframes popupEnter {
            0% { transform: scale(0.4); opacity: 0; } /* Starts smaller */
            100% { transform: scale(1); opacity: 1; }
        }

        .popup-card:hover {
            transform: scale(1.03); /* More pronounced hover */
            box-shadow: 0 15px 55px rgba(0, 0, 0, 0.95), 0 0 70px rgba(106, 130, 251, 0.9); /* Stronger hover glow */
        }

        .popup-card h2 {
            color: var(--color-gold-light);
            font-size: clamp(1.6rem, 4vw, 2.1rem); /* Adjusted font size */
            margin-top: 1.2rem;
            line-height: 1.3;
            text-shadow: 0 0 12px var(--color-gold-glow);
        }

        .popup-card .gif-top {
            position: absolute;
            top: -25px; /* Slightly higher */
            left: 50%;
            transform: translateX(-50%);
            width: 110px; /* Larger */
            height: auto;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 0 18px rgba(255, 204, 51, 0.9); /* Stronger glow */
            border: 4px solid rgba(255, 204, 51, 0.7); /* Thicker border */
            animation: floatPop 3.5s ease-in-out infinite alternate; /* Slower float */
        }

        @keyframes floatPop {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-12px); } /* More vertical movement */
            100% { transform: translateX(-50%) translateY(0); }
        }

        .popup-card .gif-main {
            max-width: 95%; /* Wider */
            height: auto;
            border-radius: var(--border-radius-md);
            margin-top: 1.2rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7), 0 0 50px rgba(255, 204, 51, 0.8); /* Stronger, softer shadow */
        }

        /* --- Sparkles (After Intro) --- */
        .sparkle {
            position: fixed;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: sparkleTwinkle 10s infinite ease-in-out; /* Slower twinkle */
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 12px var(--color-gold-glow); /* Stronger glow */
            width: 5px; /* Larger */
            height: 5px;
        }

        @keyframes sparkleTwinkle {
            0%, 100% { opacity: 0; transform: scale(0.6); }
            20%, 60% { opacity: 0.95; transform: scale(1.1); } /* More pronounced sparkle */
        }

        /* Screen shake effect for meteor shower */
        body.screen-shaking {
            animation: shake 0.6s ease-out forwards; /* Slower shake */
            animation-iteration-count: 2;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); } /* More intense shake */
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }

        /* --- New Loading Overlay (Twinkling Star & Storytelling) --- */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--color-background-start), var(--color-background-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 1.2s ease-out, visibility 1.2s ease-out; /* Slower transition */
        }

        .loading-star-container {
            width: 170px; /* Larger */
            height: 170px;
            position: relative;
            margin-bottom: 45px;
        }

        .loading-star {
            width: 100%;
            height: 100%;
            background-color: var(--color-gold-light);
            position: absolute;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            opacity: 0;
            animation: starTwinkle 3.2s ease-out forwards infinite; /* Slower twinkle */
            transform-origin: center;
            box-shadow: 0 0 45px var(--color-gold-glow); /* Stronger glow */
        }

        @keyframes starTwinkle {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            40% { transform: scale(1.3) rotate(20deg); opacity: 1; } /* More pronounced scale and rotate */
            80% { transform: scale(1.2) rotate(0deg); opacity: 0.9; }
            100% { transform: scale(0) rotate(-20deg); opacity: 0; }
        }

        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.9rem, 4vw, 2.6rem); /* Adjusted font size */
            color: var(--color-gold-light);
            opacity: 0;
            position: absolute; /* To overlap */
            transform: translateY(35px);
            animation: none; /* Controlled by JS */
            letter-spacing: 0.06em; /* Slightly more letter spacing */
            text-align: center;
            text-shadow: 0 0 15px var(--color-gold-glow);
        }
        .loading-text.active-text { /* Renamed to avoid conflict */
            animation: fadeInOutLoadingText 4.5s ease-in-out forwards; /* Slower fade */
        }

        @keyframes fadeInOutLoadingText {
            0%, 100% { opacity: 0; transform: translateY(35px); }
            25%, 75% { opacity: 1; transform: translateY(0); }
        }

        /* --- Meteor Shower Animation --- */
        .meteor {
            position: absolute;
            background: linear-gradient(45deg, #ffe9a3, #ffd700, #c9b037);
            border-radius: 50%;
            transform: rotate(45deg);
            filter: drop-shadow(0 0 18px #ffe17b); /* Stronger glow */
            opacity: 0.95;
            z-index: 3;
            width: 8px; /* Slightly larger base */
        }

        .meteor::after {
            content: '';
            position: absolute;
            width: 14px; /* Larger tail head */
            height: 14px;
            border-radius: 50%;
            top: 90%;
            left: -7px;
            background: radial-gradient(circle, #fffacd 0%, transparent 70%);
            box-shadow: 0 0 25px 10px rgba(255, 235, 150, 0.7); /* Stronger glow */
        }

        @keyframes fall {
            0% {
                transform: translate(var(--start-x), var(--start-y)) rotate(45deg);
                opacity: 0; /* Start invisible */
            }
            10% {
                opacity: 1; /* Fade in quickly */
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotate(45deg);
                opacity: 0;
            }
        }

        /* --- Wish Text --- */
        .wish-text-prompt {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-gold-light);
            font-size: clamp(2em, 4vw, 2.8em); /* Larger font */
            text-shadow: 0 0 18px var(--color-gold-glow), 0 0 30px var(--color-primary-accent); /* Stronger glow */
            animation: floatText 5.5s ease-in-out infinite; /* Slower float */
            z-index: 10;
            transition: opacity var(--transition-duration-medium) ease-in-out;
            font-family: 'Outfit', sans-serif;
            letter-spacing: 0.06em; /* Slightly more letter spacing */
            text-align: center;
            white-space: normal;
            padding: 0 1.2rem;
            box-sizing: border-box;
        }

        @keyframes floatText {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-18px); } /* More vertical movement */
        }

        /* Particle burst for meteor impact */
        .burst-particle {
            position: absolute;
            width: 8px; /* Larger */
            height: 8px;
            border-radius: 50%;
            background: #fffae0;
            box-shadow: 0 0 12px 3px #ffe99b; /* Stronger glow */
            opacity: 1;
            animation: burst 1.2s ease-out forwards; /* Slower burst */
            z-index: 5;
        }

        @keyframes burst {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; } /* Larger scale */
        }

        /* Wishing Dust Collection */
        .wishing-dust {
            position: absolute;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: wishingDustCollect 2.5s ease-out forwards; /* Slower collection */
            box-shadow: 0 0 6px var(--color-gold-glow);
            z-index: 4;
        }
        @keyframes wishingDustCollect {
            0% { transform: translate(0, 0) scale(0.6); opacity: 0.9; } /* Starts larger, more opaque */
            50% { transform: translate(var(--target-x), var(--target-y)) scale(1.1); opacity: 1; }
            100% { transform: translate(var(--target-x), var(--target-y)) scale(0.3); opacity: 0; }
        }


        /* --- Starlight Particles for "Whispers of Starlight" --- */
        .whisper-starlight-particle {
            position: fixed;
            width: 4px; /* Larger */
            height: 4px;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 10px var(--color-gold-glow); /* Stronger glow */
            animation: fallWhisperStarlight 3s ease-out forwards; /* Slower fall */
            z-index: 100;
            pointer-events: none;
        }

        @keyframes fallWhisperStarlight {
            0% { transform: translateY(-60px) translateX(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(var(--end-x-offset, 0)); opacity: 0; } /* Falls further */
        }

        /* --- Message Bubbles for "Whispers of Starlight" --- */
        .whisper-message-bubble {
            position: fixed;
            bottom: -60px; /* Starts lower */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 204, 51, 0.15); /* Slightly more opaque */
            border: 1px solid rgba(255, 204, 51, 0.5); /* Stronger border */
            color: var(--color-primary-accent);
            padding: 15px 25px; /* More padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 0 18px rgba(255, 204, 51, 0.7); /* Stronger glow */
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 1.2em; /* Larger font */
            text-align: center;
            white-space: nowrap;
            animation: floatUpAndFade 4.5s ease-out forwards; /* Slower float */
            z-index: 101;
            pointer-events: none;
            position: relative; /* For aura */
        }

        /* Ephemeral Aura for Whisper Bubbles */
        .whisper-message-bubble::after {
            content: '';
            position: absolute;
            inset: -7px; /* Larger inset */
            border-radius: var(--border-radius-lg);
            border: 3px solid rgba(224, 115, 144, 0.5); /* Thicker, more opaque aura */
            opacity: 0;
            animation: auraExpandFade 2.5s ease-out forwards; /* Slower aura expand */
            pointer-events: none;
            z-index: -1;
        }
        @keyframes auraExpandFade {
            0% { transform: scale(0.7); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        @keyframes floatUpAndFade {
            0% { transform: translateX(-50%) translateY(0); opacity: 0; }
            10% { opacity: 0.95; }
            80% { opacity: 0.95; }
            100% { transform: translateX(-50%) translateY(-220px); opacity: 0; } /* Floats higher */
        }

        /* --- Glowing Aura for "Whispers of Starlight" --- */
        body.magic-aura-active {
            animation: magicAura 3s ease-in-out forwards; /* Slower aura */
        }

        @keyframes magicAura {
            0% { box-shadow: inset 0 0 0px rgba(255, 204, 51, 0); }
            50% { box-shadow: inset 0 0 90px rgba(255, 204, 51, 0.4), inset 0 0 160px rgba(255, 204, 51, 0.2); } /* Stronger aura */
            100% { box-shadow: inset 0 0 0px rgba(255, 204, 51, 0); }
        }

        /* --- Hover Sparkle Particles (New) --- */
        .hover-sparkle {
            position: absolute;
            background-color: #fffacd;
            border-radius: 50%;
            opacity: 0;
            animation: hoverSparkleFade 1.2s ease-out forwards; /* Slower fade */
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 10px #ffcc33; /* Stronger glow */
        }

        @keyframes hoverSparkleFade {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            20% { transform: scale(1.1) translateY(-12px); opacity: 0.9; } /* More pronounced scale */
            100% { transform: scale(0.3) translateY(-35px); opacity: 0; }
        }

        /* --- Wish Orb --- */
        .wish-orb {
            position: fixed;
            bottom: 12%; /* Slightly higher */
            left: 50%;
            transform: translateX(-50%);
            width: 90px; /* Larger */
            height: 90px;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 30%, #fffacd, #ffcc33);
            box-shadow: 0 0 35px #ffcc33, 0 0 60px rgba(255, 204, 51, 0.8); /* Stronger glow */
            opacity: 0;
            animation: wishOrbAppear 3.5s ease-out forwards; /* Slower appear */
            z-index: 10;
            pointer-events: none;
        }

        @keyframes wishOrbAppear {
            0% { opacity: 0; transform: translateX(-50%) translateY(60px) scale(0.6); } /* Starts lower, larger */
            20% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); } /* More pronounced scale */
            80% { opacity: 1; transform: translateX(-50%) translateY(-60px) scale(1.15); animation-timing-function: ease-in-out; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-170px) scale(0.9); }
        }

        /* --- Final Message Overlay --- */
        #finalMessageOverlay {
            position: fixed; /* Ensures it covers the whole screen */
            inset: 0;
            background: linear-gradient(135deg, rgba(15, 25, 55, 0.98), rgba(0, 0, 0, 0.95)); /* Darker, richer gradient */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px); /* Increased blur */
            -webkit-backdrop-filter: blur(10px);
            opacity: 0; /* Initially hidden */
            visibility: hidden;
            transition: opacity var(--transition-duration-slow) ease-out, visibility var(--transition-duration-slow) ease-out;
        }

        #finalMessageOverlay.active {
            opacity: 1;
            visibility: visible;
        }

        #finalMessageOverlay > div {
            background: linear-gradient(135deg, rgba(20, 30, 60, 0.85), rgba(0, 0, 0, 0.75)); /* Gradient background */
            padding: 2.5rem; /* More padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 0 60px var(--color-accent-blue), 0 0 90px var(--color-accent-purple); /* Stronger, more diffused glow */
            backdrop-filter: blur(10px); /* Increased blur */
            -webkit-backdrop-filter: blur(10px);
            text-align: center;
            max-width: 800px;
            width: 90%; /* Responsive width */
            box-sizing: border-box; /* Include padding in width */
            margin: auto; /* Center it */
            animation: popupEnter 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Use popup entry animation */
        }

        #finalMessageOverlay h2 {
            font-size: clamp(2.2rem, 5.5vw, 3.2rem); /* Larger font */
            text-shadow: 0 0 25px var(--color-gold-glow); /* Stronger glow */
            margin-bottom: 1.5rem; /* More space below heading */
        }

        #finalMessageOverlay p {
            font-size: clamp(1.2rem, 3.2vw, 1.5rem); /* Larger font */
            margin-top: 1.8rem;
            line-height: 1.9; /* More spacious line height */
            color: var(--color-primary); /* Ensure consistent text color */
        }


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            h1 { font-size: clamp(2.2rem, 5.5vw, 2.8rem); }
            .message { font-size: clamp(0.95rem, 2.8vw, 1.05rem); padding: 1.5rem; }
            .btn { padding: 0.9rem 1.8rem; font-size: clamp(0.95rem, 2.8vw, 1.05rem); min-width: 180px; }
            .popup-card h2 { font-size: clamp(1.5rem, 4.5vw, 1.8rem); }
            .popup-card .gif-top { width: 100px; top: -20px; }
            .wish-text-prompt { font-size: clamp(1.5em, 3.8vw, 1.8em); top: 12%; }
            .love-meter-title { font-size: clamp(1.3rem, 3.2vw, 1.6rem); }
            .love-status-message { font-size: clamp(0.95rem, 2.2vw, 1.05rem); }
        }

        @media (max-width: 480px) {
            #mainContent { padding: 1.2rem; }
            h1 { font-size: clamp(2rem, 6.5vw, 2.2rem); }
            p { font-size: clamp(0.88rem, 2.8vw, 0.95rem); }
            .btn { width: calc(100% - 1.5rem); margin: 0.8rem auto; max-width: unset; }
            .popup-card h2 { font-size: clamp(1.3rem, 5vw, 1.5rem); }
            .popup-card .gif-main { width: 95%; }
            .wish-text-prompt { font-size: clamp(1.2em, 4.5vw, 1.3em); top: 10%; white-space: normal; }
            .whisper-message-bubble {
                font-size: 1em;
                padding: 10px 18px;
                white-space: normal;
                max-width: 95%;
                left: 50%;
                transform: translateX(-50%);
            }
            .background-blob { filter: blur(60px); }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="active">
        <div class="loading-star-container">
            <div class="loading-star"></div>
        </div>
        <p class="loading-text" id="loadingText1">üåå Glimpsing distant constellations...</p>
        <p class="loading-text" id="loadingText2">üí´ Stirring ancient magic...</p>
        <p class="loading-text" id="loadingText3">üíñ Crafting a universe just for you...</p>
        <audio id="loadingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-chimes-melody-1135.mp3" preload="auto" loop></audio>
    </div>

    <div id="particle-overlay"></div>

    <div class="background-blob layer-1" data-parallax-speed="0.8"></div>
    <div class="background-blob layer-2" data-parallax-speed="0.6"></div>
    <div class="background-blob layer-3" data-parallax-speed="0.4"></div>
    <div class="background-blob layer-4" data-parallax-speed="0.2"></div>

    <div class="comet-cursor" id="cometCursor"></div>

    <div class="popup hidden" id="introPopup">
        <div class="popup-card" id="popupClickArea" role="button" aria-label="Click to unwrap birthday surprise">
            <img class="gif-top" src="https://media.tenor.com/6yBqtjeP1ekAAAAj/bubu-dudu-sseeyall.gif" alt="Bubu Dudu See Ya!" loading="lazy">
            <img class="gif-main" src="https://media.tenor.com/s5AoXjOy4NsAAAAj/birthday-cake.gif" alt="Birthday Cake GIF" loading="lazy">
            <h2>A Gentle Tap to Begin Your Dreamy Birthday Journey, Quackers! ‚ú®</h2>
            <p>Click anywhere to unveil a universe crafted just for you.</p>
        </div>
    </div>

    <main class="content hidden" id="mainContent">
        <h1 class="content-block hidden" id="mainTitle">Happy Birthday, my cherished Quackers! <span aria-hidden="true">üíñ</span></h1>

        <div class="gif-inline-container content-block hidden" id="gifBlock1">
            <img src="https://media.tenor.com/kDB-vGnoBmUAAAAj/bubu-dudu-excited.gif" alt="Bubu Dudu Excited GIF" loading="lazy" />
        </div>

        <p class="message content-block hidden" id="messageBlock1">
            </p>

        <div class="button-group content-block hidden" id="chapter1ButtonGroup">
            <button id="startJourneyBtn" class="btn hidden"><span>Begin Our Journey üíñ</span></button>
        </div>

        <div id="loveMeter" class="content-block hidden">
            <p class="love-meter-title">Doofy‚Äôs Celestial Path of Affection</p>
            <div class="ribbon-container">
                <div class="shimmering-ribbon" id="loveProgressBar"></div>
                <div class="love-star-node" style="left: 0%;" data-level="0"></div>
                <div class="love-star-node" style="left: 25%;" data-level="25"></div>
                <div class="love-star-node" style="left: 50%;" data-level="50"></div>
                <div class="love-star-node" style="left: 75%;" data-level="75"></div>
                <div class="love-star-node" style="left: 100%;" data-level="100"></div>
            </div>
            <p id="loveStatusMessage" class="love-status-message">A tender whisper of budding affection. ‚ú® (Love: <span id="loveCount">0</span>%)</p>
        </div>

        <div class="gif-inline-container content-block hidden" id="gifBlock2">
            <img src="https://media.tenor.com/naYMunSvaa8AAAAj/eating-cake.gif" alt="Bubu Dudu Eating Cake GIF" loading="lazy" />
        </div>

        <div class="button-group content-block hidden" id="chapter2ButtonGroup">
            <button id="hugBtn" class="btn hidden"><span>Send a Gentle Embrace ü§ó</span></button>
            <button id="complimentsBtn" class="btn hidden"><span>Offer a Thoughtful Compliment ‚ú®</span></button>
        </div>

        <div class="content-section hidden" id="hugContentWrapper">
            <img id="hugGifDisplay" src="" alt="Hug GIF Display">
        </div>
        <div class="content-section hidden" id="complimentContentWrapper">
            <p class="message-display" id="complimentMessageDisplay"></p>
        </div>

        <div class="button-group content-block hidden" id="chapter3ButtonGroup">
            <button id="makeAWishBtn" class="btn hidden"><span>Make a Wish! üå†</span></button>
        </div>

        <div class="content-section hidden" id="makeAWishContentWrapper">
            <p class="message-display" id="makeAWishMessage"></p>
        </div>

        <div class="button-group content-block hidden" id="chapter4ButtonGroup">
             <button id="whispersOfStarlightBtn" class="btn hidden"><span>Whispers of Starlight üí´</span></button>
        </div>

         <div class="button-group content-block hidden" id="finalChapterButtonGroup">
            <button id="finalMessageBtn" class="btn hidden disabled"><span>Unveil My Heart's True Message ‚ù§Ô∏è</span></button>
        </div>


        <footer>Always your devoted Doofy üêæüíñ</footer>
    </main>

    <div id="confettiLayer"></div>
    <div class="wish-text-prompt hidden" id="wishPrompt">üå† Make your wish... üå†</div>
    <div id="meteorShowerContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 998;"></div>
    <div id="whispersContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 100;"></div>

    <div id="finalMessageOverlay" class="hidden">
        <div>
            <h2>üåô You're Someone I‚Äôm Grateful to Know</h2>
            <p>
                Quackers, today‚Äôs about you ‚Äî and I just want to say thank you. <br><br>
                For being steady. For being kind. For being you. <br><br>
                I hope your day brings you calm moments, quiet joy, and a smile that sticks around longer than expected. <br><br>
                You make things softer and safer ‚Äî and that means something. <br><br>
                Happy Birthday üíõ<br>
                ‚Äî Doofy üêæ
            </p>
        </div>
    </div>


    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-button-2575.mp3" preload="auto"></audio>
    <audio id="revealSound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkle-tinny-901.mp3" preload="auto"></audio>
    <audio id="confettiSound" src="https://assets.mixkit.co/sfx/preview/mixkit-firework-burst-1234.mp3" preload="auto"></audio>
    <audio id="celebrateSound" src="https://assets.mixkit.co/sfx/preview/mixkit-melodic-chime-bf-123.mp3" preload="auto"></audio>
    <audio id="meteorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-sci-fi-sweep-2598.mp3" preload="auto"></audio>
    <audio id="explosionSound" src="https://assets.mixkit.co/sfx/preview/mixkit-explosion-arcade-game-2520.mp3" preload="auto"></audio>
    <audio id="heartbeatSound" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-heartbeat-1090.mp3" preload="auto"></audio>
    <audio id="levelUpSound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-treasure-2067.mp3" preload="auto"></audio>
    <audio id="typewriterSound" src="https://assets.mixkit.co/sfx/preview/mixkit-typewriter-text-edit-2541.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingSound = document.getElementById('loadingSound');
            const loadingTexts = [
                document.getElementById('loadingText1'),
                document.getElementById('loadingText2'),
                document.getElementById('loadingText3')
            ];
            let currentLoadingTextIndex = 0;

            const introPopup = document.getElementById('introPopup');
            const popupClickArea = document.getElementById('popupClickArea');
            const mainContent = document.getElementById('mainContent');

            const mainTitle = document.getElementById('mainTitle');
            const gifBlock1 = document.getElementById('gifBlock1');
            const messageBlock1 = document.getElementById('messageBlock1');
            const gifBlock2 = document.getElementById('gifBlock2');

            const startJourneyBtn = document.getElementById('startJourneyBtn');
            const hugBtn = document.getElementById('hugBtn');
            const complimentsBtn = document.getElementById('complimentsBtn');
            const makeAWishBtn = document.getElementById('makeAWishBtn');
            const whispersOfStarlightBtn = document.getElementById('whispersOfStarlightBtn');
            const finalMessageBtn = document.getElementById('finalMessageBtn');

            const chapter1ButtonGroup = document.getElementById('chapter1ButtonGroup');
            const chapter2ButtonGroup = document.getElementById('chapter2ButtonGroup');
            const chapter3ButtonGroup = document.getElementById('chapter3ButtonGroup');
            const chapter4ButtonGroup = document.getElementById('chapter4ButtonGroup');
            const finalChapterButtonGroup = document.getElementById('finalChapterButtonGroup');

            const hugContentWrapper = document.getElementById('hugContentWrapper');
            const hugGifDisplay = document.getElementById('hugGifDisplay');
            const complimentContentWrapper = document.getElementById('complimentContentWrapper');
            const complimentMessageDisplay = document.getElementById('complimentMessageDisplay');
            const makeAWishContentWrapper = document.getElementById('makeAWishContentWrapper');
            const makeAWishMessage = document.getElementById('makeAWishMessage');
            const wishPrompt = document.getElementById('wishPrompt');
            const finalMessageOverlay = document.getElementById('finalMessageOverlay');

            const loveCountSpan = document.getElementById('loveCount');
            const loveProgressBar = document.getElementById('loveProgressBar');
            const loveStatusMessage = document.getElementById('loveStatusMessage');
            const loveStarNodes = document.querySelectorAll('.love-star-node');
            const confettiLayer = document.getElementById('confettiLayer');
            const particleOverlay = document.getElementById('particle-overlay');
            const loveMeterElement = document.getElementById('loveMeter');
            const meteorShowerContainer = document.getElementById('meteorShowerContainer');
            const whispersContainer = document.getElementById('whispersContainer');

            const cometCursor = document.getElementById('cometCursor');

            const clickSound = document.getElementById('clickSound');
            const revealSound = document.getElementById('revealSound');
            const confettiSound = document.getElementById('confettiSound');
            const celebrateSound = document.getElementById('celebrateSound');
            const meteorSound = document.getElementById('meteorSound');
            const explosionSound = document.getElementById('explosionSound');
            const heartbeatSound = document.getElementById('heartbeatSound');
            const levelUpSound = document.getElementById('levelUpSound');
            const typewriterSound = document.getElementById('typewriterSound');


            const hugGifs = [
                "https://media.tenor.com/ScOwzW70wHIAAAAj/bubu.gif",
                "https://media.tenor.com/2bw-Zzp-mTMAAAAj/bear-hug.gif",
                "https://media.tenor.com/F2SQcVd5fMIAAAAj/hug-couple.gif",
                "https://media.tenor.com/vzkveVGDzmAAAAj/dudu-hug-bubu-dudu-kiss.gif",
                "https://media.tenor.com/fFpVFqD_4esAAAAj/peluk.gif",
                "https://media.tenor.com/RG_lIajbbtQAAAAj/milk-and-mocha.gif",
                "https://media.tenor.com/YfaICXGzuSoAAAAj/i-love-you-i-missed-you.gif"
            ];

            const compliments = [
                "You're a beacon of calm in a chaotic world. üßò‚Äç‚ôÄÔ∏è",
                "Your kindness shines brighter than any star. ‚ú®",
                "The quiet strength you possess is truly inspiring. üí™",
                "You bring a gentle warmth to every moment. üî•",
                "Your presence is a comforting melody. üé∂",
                "You have a heart of gold, pure and true. üíõ",
                "Simply being yourself makes the world a better place. üåç",
                "Your empathy is a rare and beautiful gift. üéÅ",
                "You're as refreshing as a cool breeze on a summer day. üå¨Ô∏è",
                "May your day be filled with as much joy as you give to others. üòä"
            ];

            const whisperMessages = [
                "‚ú® Some people bring peace just by being there. You're one of them.",
                "üí´ A gentle sparkle spell for the most respected person, echoing through the cosmos!",
                "üåå Doofy's Aura of Calm activated ‚Äî your peace is MAXED, a celestial blessing!",
                "‚≠ê Your quiet radiance outshines the softest dawn, a universe of brilliance!",
                "üíñ Doofy's heart sends boundless affection, filling your cosmic space with joy!",
                "üåü May tranquility descend upon you, a starlight blessing from Doofy's devotion!",
                "‚ú® A shower of pure, serene joy just for you, shimmering with Doofy's enchantment!"
            ];

            const mainStoryMessage = "Hey sweet Quackers! ü¶Ü\n\nYour Doofy here, enveloping you in *gentle* embrace energy and warm smiles!\nJust like these adorable companions, I'm genuinely thrilled to celebrate the wonderful person you are today.\nYou‚Äôre the quiet strength in my life, the most comforting presence, and the sweetest reason to cherish every moment.\n\nMay this special day bring gentle laughter, tender solace, and a heart overflowing with quiet joy. üíï";


            let loveCount = 0;
            const maxLove = 100;
            const loveMessages = {
                0: "A tender whisper of budding affection. ‚ú®",
                10: "A soft glow of growing fondness, a new star igniting.",
                25: "Our cherished bond begins to gracefully unfold, like a nebula taking form.",
                50: "Our connection deepens, a quiet symphony of hearts, harmonizing with the cosmos.",
                75: "The profound affection within our bond strengthens, a galaxy expanding.",
                100: "üåï Your presence fills this space with quiet joy. (Love: 100%)"
            };

            const confettiColors = ['#E0E0E0', '#B0B9C6', '#6B7280', '#ffcc33'];

            // Track if one-time events/interactions have occurred
            let hugClicked = false;
            let complimentClicked = false;
            let wishMade = false;
            let starlightWhispered = false;


            // --- Core Functions ---

            function playSound(audioElement) {
                if (audioElement) {
                    audioElement.currentTime = 0;
                    audioElement.play().catch(e => console.warn("Audio play failed:", e));
                }
            }

            function stopSound(audioElement) {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
            }

            // Cosmic Calligraphy: Text reveal with glowing animation
            function typeWriterEffect(element, text, charDelay = 40, callback = () => {}) {
                let i = 0;
                // Clear any existing content
                element.innerHTML = '';
                // Ensure the element is ready for typing (its parent content-block should already be active)
                // We do NOT set visibility:visible here; the CSS classes handle it.

                // Stop any previous typing sound and start new one
                if (typewriterSound) {
                    typewriterSound.pause();
                    typewriterSound.currentTime = 0;
                    typewriterSound.play();
                }

                // Process text to handle newlines and create individual spans
                const lines = text.split('\n');
                lines.forEach((line, lineIndex) => {
                    const chars = line.split('');
                    chars.forEach(char => {
                        const span = document.createElement('span');
                        span.textContent = char === ' ' ? '\u00A0' : char; // Use non-breaking space for spaces
                        element.appendChild(span);
                    });
                    if (lineIndex < lines.length - 1) {
                        element.appendChild(document.createElement('br'));
                    }
                });

                const spans = element.querySelectorAll('span');

                function typeChar() {
                    if (i < spans.length) {
                        // Crucial fix: Only set animation delay, let CSS handle opacity change
                        spans[i].style.animationDelay = `${i * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--typewriter-char-delay'))}s`;
                        // Removed: spans[i].style.opacity = 1; (This was causing the issue)
                        i++;
                        // Use requestAnimationFrame for smoother timing
                        requestAnimationFrame(() => setTimeout(typeChar, charDelay));
                    } else {
                        if (typewriterSound) typewriterSound.pause();
                        setTimeout(() => {
                            callback();
                        }, (spans.length * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--typewriter-char-delay')) * 1000) + 900); // Wait for last char animation to finish
                    }
                }
                typeChar();
            }


            function updateLoveMeter(amount) {
                const prevLoveCount = loveCount;
                loveCount = Math.min(maxLove, loveCount + amount);
                loveCountSpan.textContent = loveCount;
                loveProgressBar.style.width = `${loveCount}%`;

                // Love Meter Aura effect and pulsing
                loveMeterElement.classList.remove('aura-level-1', 'aura-level-2', 'aura-level-3', 'aura-level-4');
                let auraClass = '';
                if (loveCount >= 25 && loveCount < 50) {
                    auraClass = 'aura-level-1';
                } else if (loveCount >= 50 && loveCount < 75) {
                    auraClass = 'aura-level-2';
                    if (prevLoveCount < 50) playSound(levelUpSound); // Milestone sound
                } else if (loveCount >= 75 && loveCount < 100) {
                    auraClass = 'aura-level-3';
                    if (prevLoveCount < 75) playSound(levelUpSound); // Milestone sound
                } else if (loveCount === 100) {
                    auraClass = 'aura-level-4';
                }
                if (auraClass) {
                     loveMeterElement.classList.add(auraClass);
                }


                // Golden Thread: Light up star nodes
                loveStarNodes.forEach(node => {
                    const level = parseInt(node.dataset.level);
                    if (loveCount >= level) {
                        node.classList.add('lit');
                    } else {
                        node.classList.remove('lit');
                    }
                });


                if (amount > 0 && loveCount < 100) {
                    loveProgressBar.classList.add('active-shimmer');
                    createLoveDustSparkles(loveMeterElement); // Trigger love dust from love meter
                } else {
                    loveProgressBar.classList.remove('active-shimmer');
                }

                if (loveCount > 0 && loveCount < 100) { // Pulse only when not full
                    loveMeterElement.classList.add('love-meter-pulsing');
                } else {
                    loveMeterElement.classList.remove('love-meter-pulsing');
                }

                let currentMessage = loveMessages[0];
                const sortedThresholds = Object.keys(loveMessages).map(Number).sort((a, b) => a - b);
                for (const threshold of sortedThresholds) {
                    if (loveCount >= threshold) {
                        currentMessage = loveMessages[threshold];
                    }
                }
                loveStatusMessage.textContent = loveCount === 100 ? loveMessages[100] : `üåº Steady and soft, like your kindness. (Love: ${loveCount}%)`;

                if (loveCount > 0 && loveCount < 100 && amount > 0) triggerConfetti(15);
                
                // NEW: Unlock buttons based on love meter progress
                if (loveCount >= 25 && chapter3ButtonGroup.classList.contains('hidden')) {
                    revealSection(chapter3ButtonGroup, 'button-group');
                    playSound(levelUpSound);
                }
                if (loveCount >= 50 && chapter4ButtonGroup.classList.contains('hidden')) {
                    revealSection(chapter4ButtonGroup, 'button-group');
                    playSound(levelUpSound);
                }

                checkFinalMessageUnlock(); // Check for final message unlock after each love update
            }


            function createLoveDustSparkles(sourceElement) {
                const rect = sourceElement.getBoundingClientRect();
                const sparkleCount = 5;
                for (let i = 0; i < sparkleCount; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle'; // Re-use sparkle class, adjust color
                    sparkle.style.left = `${rect.left + rect.width / 2}px`;
                    sparkle.style.top = `${rect.top + rect.height / 2}px`;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    sparkle.style.animationDuration = `${Math.random() * 0.8 + 0.4}s`;
                    sparkle.style.width = `${Math.random() * 4 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.backgroundColor = 'var(--color-gold-light)';
                    sparkle.style.boxShadow = '0 0 10px var(--color-gold-glow)';
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }


            function triggerConfetti(count = 30) {
                playSound(confettiSound);
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = `${-10 - Math.random() * 20}vh`;
                    confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    confetti.style.animationDelay = Math.random() * 0.6 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 4) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                    confettiLayer.appendChild(confetti);
                    confetti.addEventListener('animationend', () => confetti.remove());
                }
            }

            function createFloatingStar() {
                const star = document.createElement('div');
                star.className = 'floating-star-hug';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.animationDuration = (Math.random() * 3 + 7) + 's';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.textContent = '‚≠ê';
                document.body.appendChild(star);
                star.addEventListener('animationend', () => star.remove());
            }

            // --- New: Whispers of Starlight Effects ---

            function triggerWhispersOfStarlight(message) {
                document.body.classList.add('magic-aura-active');
                setTimeout(() => {
                    document.body.classList.remove('magic-aura-active');
                }, 3000); // Increased duration to match longer aura

                const particleCount = 40;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'whisper-starlight-particle';
                    const size = Math.random() * 3 + 1;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.animationDelay = `${Math.random() * 1.8}s`; // Slower delay
                    particle.style.animationDuration = `${Math.random() * 1.8 + 2.5}s`; // Slower duration
                    particle.style.setProperty('--end-x-offset', `${(Math.random() - 0.5) * 60}px`); // Wider spread
                    whispersContainer.appendChild(particle);
                    particle.addEventListener('animationend', () => particle.remove());
                }

                const messageBubble = document.createElement('div');
                messageBubble.className = 'whisper-message-bubble';
                messageBubble.textContent = message;
                whispersContainer.appendChild(messageBubble);
                messageBubble.addEventListener('animationend', () => messageBubble.remove());

                playSound(revealSound);
            }

            // --- Function to hide all interactive content sections ---
            function hideAllButtonContent() {
                document.querySelectorAll('.content-section').forEach(wrapper => {
                    if (wrapper.classList.contains('active')) {
                        wrapper.classList.remove('active');
                        wrapper.classList.add('hidden');
                        // Clear content for reuse
                        if (wrapper.id === 'complimentContentWrapper') {
                            wrapper.querySelector('.message-display').innerHTML = ''; // Clear text content
                        } else if (wrapper.id === 'hugContentWrapper') {
                            wrapper.querySelector('#hugGifDisplay').src = '';
                        } else if (wrapper.id === 'makeAWishContentWrapper') {
                            wrapper.querySelector('#makeAWishMessage').innerHTML = '';
                        }
                    }
                });
            }

            // --- Meteor Shower Animation Function (with Wishing Dust & Wish Orb) ---
            function triggerMeteorShower(count = 70, duration = 6000) {
                playSound(meteorSound);
                document.body.classList.add('screen-shaking');

                wishPrompt.classList.remove('hidden');

                for (let i = 0; i < count; i++) {
                    const meteor = document.createElement('div');
                    meteor.className = 'meteor';

                    const startX = window.innerWidth * (0.8 + Math.random() * 0.4);
                    const startY = -window.innerHeight * (0.1 + Math.random() * 0.2);

                    const endX = -window.innerWidth * (0.2 + Math.random() * 0.4);
                    const endY = window.innerHeight * (1.1 + Math.random() * 0.2);

                    const size = Math.random() * 4 + 4; // Larger meteors
                    meteor.style.width = `${size}px`;
                    meteor.style.height = `${size * 40}px`;

                    meteor.style.setProperty('--start-x', `${startX}px`);
                    meteor.style.setProperty('--start-y', `${startY}px`);
                    meteor.style.setProperty('--end-x', `${endX}px`);
                    meteor.style.setProperty('--end-y', `${endY}px`);

                    const animDuration = 4 + Math.random() * 3;
                    meteor.style.animation = `fall ${animDuration}s cubic-bezier(0.4, 0, 0.6, 1) forwards`;

                    meteor.style.animationDelay = `${Math.random() * (duration / 1000) * 0.8}s`;

                    meteorShowerContainer.appendChild(meteor);

                    // Attach event listener for the end of the meteor's animation
                    meteor.addEventListener('animationend', () => {
                        const meteorRect = meteor.getBoundingClientRect();
                        // Only create burst and dust if meteor is still within reasonable bounds
                        if (meteorRect.right > -50 && meteorRect.bottom > -50 && meteorRect.left < window.innerWidth + 50 && meteorRect.top < window.innerHeight + 50) {
                             createBurst(meteorRect.right, meteorRect.bottom);
                             createWishingDust(meteorRect.right, meteorRect.bottom); // Wishing Dust
                        }
                        meteor.remove();
                    }, { once: true });
                }

                setTimeout(() => {
                    document.body.classList.remove('screen-shaking');
                    wishPrompt.classList.add('hidden');
                    createWishOrb(); // Wish Orb appears after shower
                }, duration + 1000);
            }

            function createBurst(x, y) {
                playSound(explosionSound);
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'burst-particle';
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * 40;
                    const dx = Math.cos(angle) * radius;
                    const dy = Math.sin(angle) * radius;
                    particle.style.left = `${x + dx}px`;
                    particle.style.top = `${y + dy}px`;
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }
            }

            // Wishing Dust Collection
            function createWishingDust(x, y, count = 8) {
                const targetX = window.innerWidth / 2;
                const targetY = window.innerHeight * 0.8; // Lower center of screen for collection
                for (let i = 0; i < count; i++) {
                    const dust = document.createElement('div');
                    dust.className = 'wishing-dust';
                    const size = Math.random() * 4 + 2;
                    dust.style.width = `${size}px`;
                    dust.style.height = `${size}px`;
                    dust.style.left = `${x + (Math.random() - 0.5) * 20}px`;
                    dust.style.top = `${y + (Math.random() - 0.5) * 20}px`;
                    dust.style.animationDelay = `${Math.random() * 0.2}s`;
                    dust.style.setProperty('--target-x', `${targetX - dust.getBoundingClientRect().left}px`);
                    dust.style.setProperty('--target-y', `${targetY - dust.getBoundingClientRect().top}px`);
                    document.body.appendChild(dust);
                    dust.addEventListener('animationend', () => dust.remove());
                }
            }

            // Wish Orb Formation
            function createWishOrb() {
                const orb = document.createElement('div');
                orb.className = 'wish-orb';
                document.body.appendChild(orb);
                orb.addEventListener('animationend', () => orb.remove());
            }

            // --- Dynamic Background & Parallax (Blobs) ---
            function setupParallax() {
                const parallaxLayers = document.querySelectorAll('.background-blob');
                window.addEventListener('scroll', () => {
                    const scrollY = window.pageYOffset;
                    parallaxLayers.forEach(layer => {
                        const speed = parseFloat(layer.dataset.parallaxSpeed);
                        const transformY = -scrollY * speed * 0.1;
                        layer.style.transform = `translateY(${transformY}px)`;
                    });
                });
            }

            // --- Animated Particles Overlay (Stardust) ---
            function createParticles(count) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle-overlay-item';
                    particle.style.width = `${Math.random() * 4 + 1}px`;
                    particle.style.height = particle.style.width;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.top = `${Math.random() * 100}vh`;
                    particle.style.animationDelay = `${Math.random() * 15}s`;
                    particle.style.animationDuration = `${Math.random() * 7 + 10}s`;
                    particleOverlay.appendChild(particle);
                }
            }

            // --- Comet Cursor Trail ---
            document.addEventListener("mousemove", (e) => {
                cometCursor.style.left = `${e.clientX}px`;
                cometCursor.style.top = `${e.clientY}px`;
                if (!document.body.classList.contains('comet-active')) {
                    document.body.classList.add('comet-active');
                }
            });

            // --- Hover Sparkle Effect Function (New) ---
            function createHoverSparkles(event) {
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const numSparkles = 5;
                for (let i = 0; i < numSparkles; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle';
                    sparkle.style.left = `${rect.left + Math.random() * rect.width}px`;
                    sparkle.style.top = `${rect.top + Math.random() * rect.height}px`;
                    sparkle.style.width = `${Math.random() * 3 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }

            // --- Unified Section Revealer (Gentle Gliding) ---
            function revealSection(element, type = 'content-block', delay = 0) {
                setTimeout(() => {
                    element.classList.remove('hidden');
                    element.classList.add('active'); // Apply active class for transitions

                    if (type === 'button-group') {
                        // Stagger buttons within the group
                        element.querySelectorAll('.btn').forEach((btn, btnIndex) => {
                            setTimeout(() => {
                                btn.classList.remove('hidden');
                                btn.classList.add('active');
                            }, btnIndex * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stagger-unit')) * 1000);
                        });
                    }
                    
                    // Smoothly scroll to the revealed element, but only if it's not the final message overlay
                    // and not the initial content blocks which are handled by main flow
                    if (element.id !== 'finalMessageOverlay' && !element.classList.contains('content-block') && element.id !== 'messageBlock1') {
                         element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }


                }, delay);
            }

            // --- Final Message Unlock Logic ---
            function checkFinalMessageUnlock() {
                if (hugClicked && complimentClicked && wishMade && starlightWhispered) {
                    if (loveCount < 100) {
                        loveCount = 100; // Force love to 100% to ensure final stage
                        updateLoveMeter(0); // Update visuals for 100%
                    }

                    // Ensure final button is not disabled and is active
                    if (finalMessageBtn.classList.contains('disabled')) {
                        finalMessageBtn.classList.remove('disabled');
                        // Reveal final button group if it's hidden
                        if (finalChapterButtonGroup.classList.contains('hidden')) {
                            revealSection(finalChapterButtonGroup, 'button-group');
                            playSound(levelUpSound); // Play a sound for unlocking
                        }
                    }
                }
            }


            // --- Loading Screen Storytelling ---
            function startLoadingStorytelling() {
                loadingSound.play().catch(e => console.warn("Loading audio play failed:", e));

                function showNextLoadingText() {
                    if (currentLoadingTextIndex < loadingTexts.length) {
                        const currentText = loadingTexts[currentLoadingTextIndex];
                        currentText.classList.add('active-text');
                        currentText.addEventListener('animationend', () => {
                            currentText.classList.remove('active-text');
                            currentLoadingTextIndex++;
                            showNextLoadingText();
                        }, { once: true });
                    } else {
                        // All texts shown, proceed to popup
                        setTimeout(() => {
                            loadingOverlay.classList.remove('active');
                            loadingOverlay.classList.add('hidden'); // Transition out
                            loadingOverlay.addEventListener('transitionend', () => {
                                loadingOverlay.remove();
                                stopSound(loadingSound);
                            }, { once: true });
                            revealSection(introPopup, 'popup');
                        }, 500); // Small delay after last text fades
                    }
                }
                showNextLoadingText();
            }


            // --- Event Listeners ---

            window.addEventListener('load', () => {
                startLoadingStorytelling();
            });

            popupClickArea.addEventListener('click', () => {
                introPopup.classList.remove('active');
                introPopup.classList.add('hidden');
                playSound(clickSound);
                introPopup.addEventListener('transitionend', () => {
                    introPopup.style.display = 'none'; // Fully hide after transition

                    // Reveal main content elements sequentially
                    revealSection(mainContent, 'content');
                    revealSection(mainTitle, 'content-block', 300); // Delay after main content container
                    revealSection(gifBlock1, 'content-block', 600);
                    
                    setTimeout(() => {
                        // Reveal messageBlock1 (its content-block parent)
                        revealSection(messageBlock1.closest('.content-block'), 'content-block', 0); // Make its parent content-block active
                        // Then, start typing within it
                        typeWriterEffect(messageBlock1, mainStoryMessage, 40, () => {
                            revealSection(chapter1ButtonGroup, 'button-group');
                            playSound(revealSound);
                        });
                    }, 900); // Adjusted delay for typing to start after elements are in place

                    // Start background sparkles
                    setTimeout(() => {
                        for(let i = 0; i < 40; i++) {
                            const s = document.createElement('div');
                            s.className = 'sparkle';
                            s.style.left = Math.random() * 100 + 'vw';
                            s.style.top = Math.random() * 100 + 'vh';
                            s.style.animationDelay = Math.random() * 8 + 's';
                            document.body.appendChild(s);
                        }
                    }, 1000);
                }, { once: true });
            });

            startJourneyBtn.addEventListener('click', () => {
                playSound(clickSound);
                // Hide startJourneyBtn and its group
                startJourneyBtn.classList.remove('active');
                startJourneyBtn.classList.add('hidden');
                chapter1ButtonGroup.classList.remove('active');
                chapter1ButtonGroup.classList.add('hidden');

                // Reveal Love Meter, gifBlock2, and chapter2ButtonGroup
                setTimeout(() => {
                    revealSection(loveMeterElement, 'content-block');
                }, 500); // Delay for start button to fade out

                setTimeout(() => {
                    revealSection(gifBlock2, 'content-block');
                }, 1000);

                setTimeout(() => {
                    revealSection(chapter2ButtonGroup, 'button-group');
                    playSound(revealSound);
                }, 1500);
            });

            hugBtn.addEventListener('click', () => {
                playSound(clickSound);
                hideAllButtonContent(); // Hide any currently displayed content
                
                const randomGif = hugGifs[Math.floor(Math.random() * hugGifs.length)];
                hugGifDisplay.src = randomGif;
                revealSection(hugContentWrapper, 'content-section');
                
                playSound(revealSound);
                if (!hugClicked) {
                    hugClicked = true;
                    updateLoveMeter(10);
                }
                for(let i = 0; i < 5; i++) createFloatingStar();
            });

            complimentsBtn.addEventListener('click', () => {
                playSound(clickSound);
                hideAllButtonContent(); // Hide any currently displayed content
                
                revealSection(complimentContentWrapper, 'content-section');

                const randomCompliment = compliments[Math.floor(Math.random() * compliments.length)];
                typeWriterEffect(complimentMessageDisplay, randomCompliment, 40, () => {
                    playSound(revealSound);
                    if (!complimentClicked) {
                        complimentClicked = true;
                        updateLoveMeter(15);
                    }
                });
            });

            makeAWishBtn.addEventListener('click', () => {
                if (wishMade) {
                    console.log("Wish already made!");
                    return;
                }
                playSound(clickSound);
                hideAllButtonContent(); // Hide any currently displayed content
                revealSection(makeAWishContentWrapper, 'content-section');
                
                // Crucial fix: Small delay to ensure layout settles before scrolling
                setTimeout(() => {
                    messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100); 

                playSound(celebrateSound);

                triggerMeteorShower(70, 5000);
                wishMade = true;
                makeAWishBtn.classList.add('disabled');
                updateLoveMeter(25); // Update love meter after wish is made
                
            });

            whispersOfStarlightBtn.addEventListener('click', () => {
                if (starlightWhispered) {
                    console.log("Starlight already whispered!");
                    return;
                }
                playSound(clickSound);
                hideAllButtonContent(); // Hide any currently displayed content
                
                // Crucial fix: Small delay to ensure layout settles before scrolling
                setTimeout(() => {
                    messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100); 

                const randomMessage = whisperMessages[Math.floor(Math.random() * whisperMessages.length)];
                triggerWhispersOfStarlight(randomMessage);
                starlightWhispered = true;
                whispersOfStarlightBtn.classList.add('disabled');
                triggerConfetti(30);
                updateLoveMeter(30); // Update love meter after starlight is whispered
            });

            finalMessageBtn.addEventListener('click', () => {
                playSound(clickSound);
                // Hide all main content and show final message overlay
                mainContent.classList.remove('active');
                mainContent.classList.add('hidden');
                
                // Ensure the body is scrolled to the top when the final message appears
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

                mainContent.addEventListener('transitionend', () => {
                    finalMessageOverlay.classList.remove('hidden');
                    finalMessageOverlay.classList.add('active'); // Activate overlay
                    playSound(heartbeatSound);
                }, { once: true });
            });


            // --- Hover Effects ---
            const elementsWithHoverSparkles = [mainTitle, messageBlock1, loveMeterElement];
            elementsWithHoverSparkles.forEach(el => {
                el.addEventListener('mouseenter', createHoverSparkles);
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mouseenter', createHoverSparkles);
            });


            // Initial setup calls
            setupParallax();
            createParticles(60);
            updateLoveMeter(0); // Initialize love meter (sets initial styles for 0%)
        });
    </script>
</body>
</html>
