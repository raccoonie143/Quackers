<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Quackers! 💖</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:ital,wght@0,400;0,700;1,400&family=Outfit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Global Box Sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* --- CSS Variables for Theming and Consistency --- */
        :root {
            /* Moonlight & Gold Palette */
            --color-primary: #f0f0f0; /* Soft White for main text */
            --color-secondary: #c0c0c0; /* Light Gray for secondary text */
            --color-background-start: #08081a; /* Deeper Midnight Blue for gradient start */
            --color-background-end: #000000; /* Pure Black for gradient end */
            --color-accent-blue: #5a70e0; /* Soft Lavender Blue for accents */
            --color-accent-purple: #e07390; /* Muted Rose Pink for accents */
            --color-gold-light: #fffacd; /* Luminous Gold for highlights */
            --color-gold-glow: #ffcc33; /* Stronger Gold for glow effects */
            --color-primary-accent: #e0e0e0; /* Modern metallic accent color */

            /* Sizes for consistent spacing and rounding */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 20px; /* Slightly reduced for better responsiveness */

            /* Animation Durations and Delays */
            --transition-duration-slow: 1.0s;
            --transition-duration-medium: 0.7s;
            --transition-duration-fast: 0.4s;
            --stagger-unit: 0.08s; /* Slightly faster stagger */
            --typewriter-char-delay: 0.02s; /* Delay between characters in typewriter effect */

            /* Dynamic Love Meter Aura Colors (used in JS for class toggling) */
            --love-aura-0: rgba(90, 112, 224, 0.4);
            --love-aura-25: rgba(90, 112, 224, 0.6);
            --love-aura-50: rgba(90, 112, 224, 0.8);
            --love-aura-75: rgba(224, 115, 144, 0.9);
            --love-aura-100: rgba(255, 204, 51, 0.9);
        }

        /* --- Global Body Styles --- */
        body {
            font-family: 'Lora', serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            background: linear-gradient(135deg, var(--color-background-start), var(--color-background-end));
            background-size: 200% 200%;
            animation: cosmicGradient 60s ease infinite alternate;
            color: var(--color-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: none; /* Custom cursor */
            transition: background var(--transition-duration-slow) ease-in-out;
            will-change: background-position;
        }

        /* Deeper Celestial Background: Nebula Effect */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            opacity: 0.15;
            filter: blur(150px); /* Slightly less blur for crispness */
            z-index: -1;
            animation: nebulaDrift 80s ease-in-out infinite alternate;
            will-change: transform, opacity;
        }

        body::before {
            background: radial-gradient(circle at 70% 30%, var(--color-accent-blue), transparent);
            width: clamp(800px, 100vw, 1300px); /* Responsive sizing */
            height: clamp(800px, 100vw, 1300px);
            top: -25%; /* Use percentage for responsive positioning */
            left: -25%;
            animation-delay: 0s;
        }

        body::after {
            background: radial-gradient(circle at 30% 70%, var(--color-accent-purple), transparent);
            width: clamp(700px, 90vw, 1100px);
            height: clamp(700px, 90vw, 1100px);
            bottom: -25%;
            right: -25%;
            animation-delay: 5s;
        }

        /* Keyframe Animations */
        @keyframes nebulaDrift {
            0% { transform: translate(0, 0) scale(1); opacity: 0.15; }
            50% { transform: translate(120px, 60px) scale(1.06); opacity: 0.2; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.15; }
        }

        @keyframes cosmicGradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* --- Text Styles --- */
        h1, h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-gold-light);
            text-align: center;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 12px var(--color-gold-glow), 0 0 25px rgba(255, 204, 51, 0.5);
        }

        p {
            line-height: 1.7;
            text-align: center;
            color: var(--color-secondary);
        }

        /* --- Utility Classes for Visibility and Transitions --- */
        .hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(30px);
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out, visibility var(--transition-duration-slow) ease-out;
        }

        .active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
        }

        /* Main Content Container */
        .content {
            padding: clamp(1rem, 5vw, 2.5rem); /* Responsive padding */
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 5;
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
        }

        /* Individual Content Blocks (e.g., messages, GIFs, love meter) */
        .content-block {
            margin-bottom: clamp(1.5rem, 4vw, 2.5rem); /* Responsive margin */
            filter: blur(8px);
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out, filter var(--transition-duration-slow) ease-out;
        }

        .content-block.active {
            filter: blur(0);
        }

        /* GIF Container Styling */
        .gif-inline-container {
            display: flex;
            justify-content: center;
            margin: clamp(1.5rem, 4vw, 2.5rem) 0; /* Responsive margin */
        }

        .gif-inline-container img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 40px var(--color-accent-blue);
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        .gif-inline-container img:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), 0 0 50px var(--color-accent-blue);
        }

        /* Message Box Styling (for main story and wish confirmation) */
        .message {
            background: linear-gradient(135deg, rgba(10, 20, 50, 0.45), rgba(0, 0, 0, 0.35));
            padding: clamp(1.5rem, 5vw, 2rem); /* Responsive padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 45px rgba(106, 130, 251, 0.4);
            border: 1px solid rgba(106, 130, 251, 0.4);
            width: 100%;
            max-width: 750px;
            margin: clamp(1.8rem, 5vw, 2.5rem) auto; /* Responsive margin */
            font-size: clamp(0.95rem, 2.5vw, 1.15rem);
            color: var(--color-primary);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            position: relative;
            overflow: hidden;
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            text-align: center;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
        }

        /* --- New Styling for messageBlock1 (Main Story Message) --- */
        #messageBlock1.message {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            background-image: linear-gradient(120deg, #fffae0, #ffcc33, #fffacd);
            text-shadow: 0 0 15px rgba(255, 204, 51, 0.8), 0 0 30px rgba(255, 204, 51, 0.5);
            line-height: 1.6;
            letter-spacing: 0.02em;
            animation: messagePopOut 1.5s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 1.2s ease-out, transform 1.2s ease-out, box-shadow 0.4s ease;
        }

        @keyframes messagePopOut {
            0% { opacity: 0; transform: scale(0.9) translateY(20px); }
            60% { opacity: 1; transform: scale(1.02) translateY(-5px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Hover aura for message/text elements */
        .message:hover, h1:hover {
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 50px var(--color-accent-blue), 0 0 70px var(--color-accent-purple);
            transition: box-shadow var(--transition-duration-fast) ease;
        }

        /* Button Group Container */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: clamp(15px, 3vw, 25px); /* Responsive gap */
            padding: clamp(1.5rem, 4vw, 2rem) 0; /* Responsive padding */
            margin-top: clamp(1.8rem, 5vw, 2.5rem); /* Responsive margin */
            transition: opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
        }

        /* Button Styling */
        .btn {
            background: linear-gradient(45deg, var(--color-accent-blue), var(--color-accent-purple));
            color: var(--color-primary);
            border: none;
            border-radius: var(--border-radius-lg);
            padding: clamp(0.9rem, 3vw, 1.1rem) clamp(1.8rem, 5vw, 2.2rem); /* Responsive padding */
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.95rem, 2.5vw, 1.15rem);
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 30px var(--color-accent-blue);
            transition: all var(--transition-duration-fast) ease, opacity var(--transition-duration-medium) ease;
            flex-grow: 1;
            min-width: clamp(180px, 50vw, 220px); /* Responsive min-width */
            max-width: 300px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            filter: grayscale(80%);
        }

        /* Starlight Pulse: Button border glow on hover */
        .btn:not(.disabled):hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 40px var(--color-accent-blue), inset 0 0 20px var(--color-gold-glow);
            background: linear-gradient(45deg, #7b92ff, #ff6a8b);
            animation: starlightPulse 1.8s infinite alternate ease-in-out;
        }
        @keyframes starlightPulse {
            0% { box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 40px var(--color-accent-blue), inset 0 0 8px var(--color-gold-glow); }
            100% { box-shadow: 0 10px 35px rgba(0, 0, 0, 0.7), 0 0 50px var(--color-accent-blue), inset 0 0 25px var(--color-gold-glow); }
        }

        .btn:not(.disabled):active {
            transform: translateY(0) scale(0.97);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .btn span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        /* Subtle Inner Aura (On Click) for buttons */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: rgba(255, 204, 51, 0.4);
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }
        .btn:active::after {
            width: 250px;
            height: 250px;
            opacity: 1;
            transition: 0s;
        }

        /* Footer Styling */
        footer {
            margin-top: clamp(2rem, 5vw, 3rem);
            padding: clamp(1.5rem, 5vw, 2.5rem);
            color: var(--color-secondary);
            font-family: 'Lora', serif;
            font-size: clamp(0.85em, 2.5vw, 0.95em);
            text-align: center;
            opacity: 0.8;
            z-index: 5;
            position: relative;
        }

        /* --- Specific Content Sections (e.g., Hug GIF, Compliment Message) --- */
        .content-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: clamp(1.5rem, 4vw, 1.8rem);
            margin-bottom: clamp(1.5rem, 4vw, 2rem);
            padding: 0 clamp(0.5rem, 3vw, 1.2rem); /* Added horizontal padding */
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            transition: opacity var(--transition-duration-medium) ease-out, transform var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
        }

        #hugGifDisplay {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 40px var(--color-accent-purple);
            margin-bottom: 0.8rem;
        }

        /* Message Display for Compliments and Wish Confirmation */
        .message-display {
            background: linear-gradient(135deg, rgba(10, 20, 50, 0.55), rgba(0, 0, 0, 0.45));
            padding: clamp(1.2rem, 4vw, 1.8rem); /* Responsive padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6), 0 0 35px var(--color-accent-purple);
            font-style: italic;
            font-size: clamp(1.05rem, 3vw, 1.25rem); /* Adjusted font size for better fit */
            color: var(--color-primary);
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            overflow: hidden;
            white-space: normal; /* Allow text to wrap */
            word-break: break-word; /* Break long words */
            overflow-wrap: break-word; /* Modern equivalent */
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* No need for padding here, it's already in the main rule */
        }
        .message-display span {
            opacity: 0;
            animation: textFadeInGlow 0.9s forwards;
            animation-timing-function: cubic-bezier(0.2, 0.8, 0.4, 1.2);
            display: inline-block;
            text-shadow: none;
            color: var(--color-primary);
        }
        @keyframes textFadeInGlow {
            0% { opacity: 0; transform: translateY(8px); text-shadow: 0 0 0px var(--color-gold-glow); }
            30% { opacity: 1; transform: translateY(0); text-shadow: 0 0 5px var(--color-gold-glow); }
            100% { opacity: 1; text-shadow: 0 0 0px var(--color-gold-glow); }
        }

        /* --- Love Meter (Golden Thread of Light) --- */
        #loveMeter {
            background: linear-gradient(135deg, rgba(20, 30, 60, 0.65), rgba(0, 0, 0, 0.55));
            border-radius: var(--border-radius-lg);
            padding: clamp(1.5rem, 5vw, 2rem); /* Responsive padding */
            margin-top: clamp(1.8rem, 5vw, 2.5rem);
            box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 40px var(--color-accent-blue);
            text-align: center;
            transition: box-shadow var(--transition-duration-medium) ease-in-out, opacity var(--transition-duration-slow) ease-out, transform var(--transition-duration-slow) ease-out;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            position: relative;
        }

        #loveMeter.love-meter-pulsing {
            animation: lovePulse 1.8s infinite alternate ease-in-out;
        }

        @keyframes lovePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.015); }
        }

        /* Love Meter Aura based on fill percentage (Dynamic in JS) */
        #loveMeter.aura-level-1 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 45px var(--love-aura-25); }
        #loveMeter.aura-level-2 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 55px var(--love-aura-50); }
        #loveMeter.aura-level-3 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 65px var(--love-aura-75); }
        #loveMeter.aura-level-4 { box-shadow: 0 12px 45px rgba(0, 0, 0, 0.8), 0 0 75px var(--love-aura-100), 0 0 100px var(--love-aura-100); }

        .love-meter-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.5rem, 3.5vw, 2.1rem);
            color: var(--color-gold-light);
            margin-bottom: 1.2rem;
            text-shadow: 0 0 12px var(--color-gold-glow);
        }

        .ribbon-container {
            width: clamp(80%, 70vw, 550px); /* Responsive width */
            height: clamp(18px, 2.5vw, 22px); /* Responsive height */
            background-color: #3a3a5a;
            border-radius: 12px;
            overflow: hidden;
            margin: clamp(0.8rem, 2vw, 1.2rem) auto;
            box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .shimmering-ribbon {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ffcc33, #ffd700, #fffa8c, #ffd700, #ffcc33);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width var(--transition-duration-medium) ease-out;
            box-shadow: 0 0 18px rgba(255, 215, 0, 0.9);
            position: relative;
            z-index: 1;
        }

        .shimmering-ribbon.active-shimmer {
            animation: shimmerEffect 2.5s linear infinite;
        }

        @keyframes shimmerEffect {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }

        /* Golden Thread: Love Star Nodes */
        .love-star-node {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: clamp(10px, 1.5vw, 14px); /* Responsive size */
            height: clamp(10px, 1.5vw, 14px);
            background-color: #555;
            border-radius: 50%;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.6);
            z-index: 0;
            transition: background-color var(--transition-duration-medium) ease, box-shadow var(--transition-duration-medium) ease;
        }
        .love-star-node.lit {
            background-color: var(--color-gold-light);
            box-shadow: 0 0 12px var(--color-gold-glow), 0 0 25px rgba(255, 204, 51, 0.6);
            animation: nodePulse 1.8s infinite alternate;
        }
        @keyframes nodePulse {
            0% { transform: translateY(-50%) scale(1); }
            100% { transform: translateY(-50%) scale(1.15); }
        }

        .love-status-message {
            font-size: clamp(1.05rem, 2.5vw, 1.15rem);
            color: var(--color-secondary);
            margin-top: clamp(0.8rem, 2vw, 1.2rem);
        }

        /* --- Confetti Effect --- */
        #confettiLayer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }

        .confetti-piece {
            position: absolute;
            width: clamp(8px, 1.5vw, 10px);
            height: clamp(8px, 1.5vw, 10px);
            background-color: #f00; /* Default, overridden by JS */
            opacity: 0;
            animation: fallAndTwist 3.5s ease-out forwards;
            border-radius: 3px;
            filter: blur(0.7px);
        }

        @keyframes fallAndTwist {
            0% { transform: translateY(-10vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(1); opacity: 0; }
        }

        /* --- Floating Stars for Hug Button --- */
        .floating-star-hug {
            position: fixed;
            font-size: clamp(2em, 5vw, 2.8em);
            opacity: 0;
            animation: floatUp 5.5s ease-out forwards;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-180px); opacity: 0; }
        }

        /* --- Background Blobs (Parallax Effect) --- */
        .background-blob {
            position: fixed;
            border-radius: 50%;
            opacity: 0.6;
            filter: blur(100px); /* Slightly less blur for performance */
            z-index: 0;
            transition: transform var(--transition-duration-fast) linear;
            pointer-events: none;
            will-change: transform;
        }

        .layer-1 {
            background-color: rgba(90, 112, 224, 0.25);
            width: clamp(500px, 80vw, 650px);
            height: clamp(500px, 80vw, 650px);
            top: -10%;
            left: -10%;
        }

        .layer-2 {
            background-color: rgba(224, 115, 144, 0.25);
            width: clamp(650px, 90vw, 850px);
            height: clamp(650px, 90vw, 850px);
            bottom: -15%;
            right: -15%;
        }

        .layer-3 {
            background-color: rgba(255, 204, 51, 0.2);
            width: clamp(350px, 60vw, 450px);
            height: clamp(350px, 60vw, 450px);
            top: 50%;
            left: 12%;
            transform: translateY(-50%);
        }
        .layer-4 {
            background-color: rgba(90, 112, 224, 0.2);
            width: clamp(450px, 70vw, 550px);
            height: clamp(450px, 70vw, 550px);
            bottom: 12%;
            left: 22%;
            transform: translateX(-50%);
        }

        /* --- Particle Overlay (Stardust Effect) --- */
        #particle-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle-overlay-item {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 12s infinite ease-in-out;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.6); }
            50% { opacity: 0.9; transform: scale(1.1); }
        }

        /* --- Comet Cursor Trail --- */
        .comet-cursor {
            position: fixed;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #ffe17b 0%, #ffcc33 50%, transparent 80%);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 1000; /* Ensure high z-index */
            filter: drop-shadow(0 0 18px rgba(255, 204, 51, 0.9));
            opacity: 0;
            transition: opacity var(--transition-duration-medium) ease;
        }

        body.comet-active .comet-cursor {
            opacity: 1;
        }

        .comet-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 3px;
            height: 90px;
            background: linear-gradient(to bottom, #fffae0, #ffcc33, transparent);
            transform: translate(-50%, 0) rotate(45deg);
            transform-origin: top;
            filter: blur(12px);
        }

        /* --- Popup Styles (for intro and final message) --- */
        .popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: opacity var(--transition-duration-medium) ease-out, visibility var(--transition-duration-medium) ease-out;
        }

        .popup-card {
            background: linear-gradient(135deg, rgba(20, 30, 60, 0.98), rgba(0, 0, 0, 0.95));
            border-radius: var(--border-radius-lg);
            padding: clamp(2rem, 6vw, 2.8rem); /* Responsive padding */
            max-width: 550px;
            width: 92%;
            text-align: center;
            box-shadow: 0 12px 45px rgba(0, 0, 0, 0.9), 0 0 60px rgba(106, 130, 251, 0.8);
            position: relative;
            animation: popupEnter 0.9s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            cursor: pointer;
            border: 2px solid rgba(106, 130, 251, 0.7);
            transition: transform var(--transition-duration-fast) ease, box-shadow var(--transition-duration-fast) ease;
        }

        @keyframes popupEnter {
            0% { transform: scale(0.4); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .popup-card:hover {
            transform: scale(1.03);
            box-shadow: 0 15px 55px rgba(0, 0, 0, 0.95), 0 0 70px rgba(106, 130, 251, 0.9);
        }

        .popup-card h2 {
            color: var(--color-gold-light);
            font-size: clamp(1.6rem, 4vw, 2.1rem);
            margin-top: 1.2rem;
            line-height: 1.3;
            text-shadow: 0 0 12px var(--color-gold-glow);
        }

        .popup-card .gif-top {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(90px, 18vw, 110px); /* Responsive width */
            height: auto;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 0 18px rgba(255, 204, 51, 0.9);
            border: 4px solid rgba(255, 204, 51, 0.7);
            animation: floatPop 3.5s ease-in-out infinite alternate;
        }

        @keyframes floatPop {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-12px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        .popup-card .gif-main {
            max-width: 95%;
            height: auto;
            border-radius: var(--border-radius-md);
            margin-top: 1.2rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7), 0 0 50px rgba(255, 204, 51, 0.8);
        }

        /* --- Sparkles (After Intro) --- */
        .sparkle {
            position: fixed;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: sparkleTwinkle 10s infinite ease-in-out;
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 12px var(--color-gold-glow);
            width: clamp(3px, 0.8vw, 5px);
            height: clamp(3px, 0.8vw, 5px);
        }

        @keyframes sparkleTwinkle {
            0%, 100% { opacity: 0; transform: scale(0.6); }
            20%, 60% { opacity: 0.95; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(0.6); }
        }

        /* Screen shake effect for meteor shower */
        body.screen-shaking {
            animation: shake 0.6s ease-out forwards;
            animation-iteration-count: 2;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            50% { transform: translateX(8px); }
            75% { transform: translateX(-8px); }
        }

        /* --- Loading Overlay (Twinkling Star & Storytelling) --- */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--color-background-start), var(--color-background-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 1.2s ease-out, visibility 1.2s ease-out;
        }

        .loading-star-container {
            width: clamp(120px, 25vw, 170px);
            height: clamp(120px, 25vw, 170px);
            position: relative;
            margin-bottom: clamp(20px, 5vw, 45px);
        }

        .loading-star {
            width: 100%;
            height: 100%;
            background-color: var(--color-gold-light);
            position: absolute;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            opacity: 0;
            animation: starTwinkle 3.2s ease-out forwards infinite;
            transform-origin: center;
            box-shadow: 0 0 45px var(--color-gold-glow);
        }

        @keyframes starTwinkle {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            40% { transform: scale(1.3) rotate(20deg); opacity: 1; }
            80% { transform: scale(1.2) rotate(0deg); opacity: 0.9; }
            100% { transform: scale(0) rotate(-20deg); opacity: 0; }
        }

        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.6rem, 4vw, 2.6rem);
            color: var(--color-gold-light);
            opacity: 0;
            position: absolute;
            transform: translateY(35px);
            animation: none;
            letter-spacing: 0.06em;
            text-align: center;
            text-shadow: 0 0 15px var(--color-gold-glow);
            padding: 0 1rem; /* Added padding to prevent text overflow */
        }
        .loading-text.active-text {
            animation: fadeInOutLoadingText 4.5s ease-in-out forwards;
        }

        @keyframes fadeInOutLoadingText {
            0%, 100% { opacity: 0; transform: translateY(35px); }
            25%, 75% { opacity: 1; transform: translateY(0); }
        }

        /* --- Meteor Shower Animation --- */
        .meteor {
            position: absolute;
            background: linear-gradient(45deg, #ffe9a3, #ffd700, #c9b037);
            border-radius: 50%;
            transform: rotate(45deg);
            filter: drop-shadow(0 0 18px #ffe17b);
            opacity: 0.95;
            z-index: 3;
            width: clamp(6px, 1.2vw, 8px);
        }

        .meteor::after {
            content: '';
            position: absolute;
            width: clamp(10px, 1.8vw, 14px);
            height: clamp(10px, 1.8vw, 14px);
            border-radius: 50%;
            top: 90%;
            left: -7px;
            background: radial-gradient(circle, #fffacd 0%, transparent 70%);
            box-shadow: 0 0 25px 10px rgba(255, 235, 150, 0.7);
        }

        @keyframes fall {
            0% {
                transform: translate(var(--start-x), var(--start-y)) rotate(45deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotate(45deg);
                opacity: 0;
            }
        }

        /* --- Wish Text Prompt --- */
        .wish-text-prompt {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--color-gold-light);
            font-size: clamp(1.8em, 4.5vw, 2.8em);
            text-shadow: 0 0 18px var(--color-gold-glow), 0 0 30px var(--color-primary-accent);
            animation: floatText 5.5s ease-in-out infinite;
            z-index: 10;
            transition: opacity var(--transition-duration-medium) ease-in-out;
            font-family: 'Outfit', sans-serif;
            letter-spacing: 0.06em;
            text-align: center;
            white-space: normal;
            padding: 0 clamp(0.8rem, 4vw, 1.2rem);
        }

        @keyframes floatText {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-18px); }
        }

        /* Particle burst for meteor impact */
        .burst-particle {
            position: absolute;
            width: clamp(6px, 1.2vw, 8px);
            height: clamp(6px, 1.2vw, 8px);
            border-radius: 50%;
            background: #fffae0;
            box-shadow: 0 0 12px 3px #ffe99b;
            opacity: 1;
            animation: burst 1.2s ease-out forwards;
            z-index: 5;
        }

        @keyframes burst {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        /* Wishing Dust Collection */
        .wishing-dust {
            position: absolute;
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            animation: wishingDustCollect 2.5s ease-out forwards;
            box-shadow: 0 0 6px var(--color-gold-glow);
            z-index: 4;
        }
        @keyframes wishingDustCollect {
            0% { transform: translate(0, 0) scale(0.6); opacity: 0.9; }
            50% { transform: translate(var(--target-x), var(--target-y)) scale(1.1); opacity: 1; }
            100% { transform: translate(var(--target-x), var(--target-y)) scale(0.3); opacity: 0; }
        }

        /* --- Starlight Particles for "Whispers of Starlight" --- */
        .whisper-starlight-particle {
            position: fixed;
            width: clamp(3px, 0.8vw, 4px);
            height: clamp(3px, 0.8vw, 4px);
            background-color: var(--color-gold-light);
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 10px var(--color-gold-glow);
            animation: fallWhisperStarlight 3s ease-out forwards;
            z-index: 100;
            pointer-events: none;
        }

        @keyframes fallWhisperStarlight {
            0% { transform: translateY(-60px) translateX(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(var(--end-x-offset, 0)); opacity: 0; }
        }

        /* --- Message Bubbles for "Whispers of Starlight" --- */
        .whisper-message-bubble {
            position: fixed;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 204, 51, 0.15);
            border: 1px solid rgba(255, 204, 51, 0.5);
            color: var(--color-primary-accent);
            padding: clamp(10px, 3vw, 15px) clamp(18px, 4vw, 25px); /* Responsive padding */
            border-radius: var(--border-radius-lg);
            box-shadow: 0 0 18px rgba(255, 204, 51, 0.7);
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: clamp(1em, 2.5vw, 1.2em);
            text-align: center;
            white-space: nowrap; /* Allow wrapping on smaller screens */
            animation: floatUpAndFade 4.5s ease-out forwards;
            z-index: 101;
            pointer-events: none;
            position: relative;
            max-width: 90%; /* Ensure it doesn't overflow */
        }

        /* Ephemeral Aura for Whisper Bubbles */
        .whisper-message-bubble::after {
            content: '';
            position: absolute;
            inset: -7px;
            border-radius: var(--border-radius-lg);
            border: 3px solid rgba(224, 115, 144, 0.5);
            opacity: 0;
            animation: auraExpandFade 2.5s ease-out forwards;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes auraExpandFade {
            0% { transform: scale(0.7); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        @keyframes floatUpAndFade {
            0% { transform: translateX(-50%) translateY(0); opacity: 0; }
            10% { opacity: 0.95; }
            80% { opacity: 0.95; }
            100% { transform: translateX(-50%) translateY(-220px); opacity: 0; }
        }

        /* --- Glowing Aura for "Whispers of Starlight" --- */
        body.magic-aura-active {
            animation: magicAura 3s ease-in-out forwards;
        }

        @keyframes magicAura {
            0% { box-shadow: inset 0 0 0px rgba(255, 204, 51, 0); }
            50% { box-shadow: inset 0 0 90px rgba(255, 204, 51, 0.4), inset 0 0 160px rgba(255, 204, 51, 0.2); }
            100% { box-shadow: inset 0 0 0px rgba(255, 204, 51, 0); }
        }

        /* --- Hover Sparkle Particles --- */
        .hover-sparkle {
            position: absolute;
            background-color: #fffacd;
            border-radius: 50%;
            opacity: 0;
            animation: hoverSparkleFade 1.2s ease-out forwards;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 10px #ffcc33;
        }

        @keyframes hoverSparkleFade {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            20% { transform: scale(1.1) translateY(-12px); opacity: 0.9; }
            100% { transform: scale(0.3) translateY(-35px); opacity: 0; }
        }

        /* --- Wish Orb --- */
        .wish-orb {
            position: fixed;
            bottom: 12%;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(70px, 15vw, 90px);
            height: clamp(70px, 15vw, 90px);
            border-radius: 50%;
            background: radial-gradient(circle at 70% 30%, #fffacd, #ffcc33);
            box-shadow: 0 0 35px #ffcc33, 0 0 60px rgba(255, 204, 51, 0.8);
            opacity: 0;
            animation: wishOrbAppear 3.5s ease-out forwards;
            z-index: 10;
            pointer-events: none;
        }

        @keyframes wishOrbAppear {
            0% { opacity: 0; transform: translateX(-50%) translateY(60px) scale(0.6); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); }
            80% { opacity: 1; transform: translateX(-50%) translateY(-60px) scale(1.15); animation-timing-function: ease-in-out; }
            100% { opacity: 0; transform: translateX(-50%) translateY(-170px) scale(0.9); }
        }

        /* --- Final Message Overlay - REDESIGNED & FIXED SCROLLING --- */
        #finalMessageOverlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #0a0a20 0%, #000000 100%); /* Softer, ethereal background */
            display: flex;
            flex-direction: column; /* Changed to column */
            align-items: center; /* Center horizontally */
            justify-content: flex-start; /* Align to top to allow scrolling */
            z-index: 2000;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-duration-slow) ease-out, visibility var(--transition-duration-slow) ease-out;
            cursor: none;
            overflow-y: auto; /* IMPORTANT: Enable vertical scrolling for the overlay itself */
            padding-top: clamp(2rem, 5vw, 4rem); /* Add top padding for spacing on scroll */
            padding-bottom: clamp(2rem, 5vw, 4rem); /* Add bottom padding for spacing on scroll */
        }

        #finalMessageOverlay.active {
            opacity: 1;
            visibility: visible;
        }

        #finalMessageOverlay .final-message-card { /* New class for the card */
            background: linear-gradient(135deg, rgba(25, 35, 70, 0.6), rgba(0, 0, 0, 0.5));
            border-radius: var(--border-radius-lg);
            padding: clamp(2rem, 5vw, 3.5rem); /* Generous padding */
            max-width: 700px; /* Max width for readability */
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(106, 130, 251, 0.5), 0 0 80px rgba(224, 115, 144, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            margin-left: auto; /* Center horizontally */
            margin-right: auto; /* Center horizontally */
            /* Removed margin: auto; that centered vertically and prevented scroll */
            animation: popupEnter 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(106, 130, 251, 0.3);
            position: relative;
            overflow: hidden;
            min-height: fit-content; /* Ensure it's not squashed */
            max-height: 90vh; /* Allow internal scrolling if content is super long */
        }

        /* Inner particles for the final message card */
        .final-message-card::before, .final-message-card::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, #fffacd 0%, transparent 70%);
            opacity: 0.1;
            filter: blur(20px);
            pointer-events: none;
            animation: floatAndFade 20s infinite ease-in-out alternate;
        }
        .final-message-card::before {
            width: 150px; height: 150px;
            top: 10%; left: 10%;
            animation-delay: 0s;
        }
        .final-message-card::after {
            width: 180px; height: 180px;
            bottom: 15%; right: 10%;
            animation-delay: 5s;
        }
        @keyframes floatAndFade {
            0% { transform: translate(0, 0) scale(1); opacity: 0.1; }
            50% { transform: translate(20px, 15px) scale(1.05); opacity: 0.15; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.1; }
        }

        #finalMessageOverlay h2 {
            font-size: clamp(2.5rem, 5vw, 3.8rem); /* Larger, more impactful heading */
            color: var(--color-gold-light);
            text-shadow: 0 0 20px var(--color-gold-glow), 0 0 40px rgba(255, 204, 51, 0.6);
            margin-bottom: clamp(1rem, 2.5vw, 1.5rem);
            line-height: 1.2;
            letter-spacing: 0.03em; /* Slightly more space for elegance */
        }

        #finalMessageOverlay p {
            font-family: 'Lora', serif; /* Use Lora for body text for elegance */
            font-size: clamp(1.15rem, 2.5vw, 1.4rem); /* Refined font size for main text */
            margin-top: clamp(1.5rem, 3vw, 2rem);
            line-height: 1.9; /* More generous line height for readability */
            color: var(--color-primary);
            max-width: 600px; /* Control line length */
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            text-shadow: 0 0 5px rgba(0,0,0,0.3); /* Subtle text shadow */
            word-wrap: break-word; /* Ensure text wraps within paragraph */
            overflow-wrap: break-word; /* Modern equivalent */
            hyphens: auto; /* Allow hyphenation for better word breaking */
        }

        #finalMessageOverlay .btn { /* Restyle the button for the final page */
            background: linear-gradient(45deg, #7b92ff, #ff6a8b); /* Softer, blended gradient */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 25px rgba(255, 204, 51, 0.5); /* Softer glow */
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            padding: clamp(1rem, 3vw, 1.2rem) clamp(2rem, 5vw, 2.5rem);
            min-width: unset; /* Remove min-width to allow content to dictate size */
            margin-top: clamp(2rem, 4vw, 3rem); /* More space above button */
        }
        #finalMessageOverlay .btn:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6), 0 0 40px rgba(255, 204, 51, 0.7), inset 0 0 15px var(--color-gold-light);
            background: linear-gradient(45deg, #8ba0ff, #ff899b); /* Slightly brighter on hover */
            transform: translateY(-3px) scale(1.02);
        }


        /* Music hint text */
        .music-hint {
            font-family: 'Lora', serif;
            font-size: clamp(0.8em, 2vw, 0.9em); /* Responsive font size */
            color: var(--color-secondary);
            opacity: 0.7;
            margin-top: -1.2rem;
            margin-bottom: clamp(1.2rem, 3vw, 1.8rem);
            text-align: center;
            transition: opacity 0.5s ease-out;
            pointer-events: none;
            padding: 0 0.8rem; /* Add padding to prevent overflow on very small screens */
        }
    </style>
</head>
<body>

    <audio id="introMusic" loop>
        <source src="music1.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="mainMusic" loop>
        <source src="music2.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="loadingOverlay" class="active">
        <div class="loading-star-container">
            <div class="loading-star"></div>
        </div>
        <p class="loading-text" id="loadingText1">🌌 Glimpsing distant constellations...</p>
        <p class="loading-text" id="loadingText2">💫 Stirring ancient magic...</p>
        <p class="loading-text" id="loadingText3">💖 Crafting a universe just for you...</p>
    </div>

    <div id="particle-overlay"></div>

    <div class="background-blob layer-1" data-parallax-speed="0.8"></div>
    <div class="background-blob layer-2" data-parallax-speed="0.6"></div>
    <div class="background-blob layer-3" data-parallax-speed="0.4"></div>
    <div class="background-blob layer-4" data-parallax-speed="0.2"></div>

    <div class="comet-cursor" id="cometCursor"></div>

    <div class="popup hidden" id="introPopup">
        <div class="popup-card" id="popupClickArea" role="button" aria-label="Click to unwrap birthday surprise">
            <img class="gif-top" src="https://media.tenor.com/6yBqtjeP1ekAAAAj/bubu-dudu-sseeyall.gif" alt="Bubu Dudu See Ya!" loading="lazy">
            <img class="gif-main" src="https://media.tenor.com/s5AoXjOy4NsAAAAj/birthday-cake.gif" alt="Birthday Cake GIF" loading="lazy">
            <h2>A Gentle Tap to Begin Your Dreamy Birthday Journey, Quackers! ✨</h2>
            <p>Click anywhere to unveil a universe crafted just for you.</p>
        </div>
    </div>

    <main class="content hidden" id="mainContent">
        <h1 class="content-block hidden" id="mainTitle">Happy Birthday, my cherished Quackers! <span aria-hidden="true">💖</span></h1>
        <p class="music-hint hidden" id="musicHint">🎶 Listen closely, this melody is just for you... 💖</p>


        <div class="gif-inline-container content-block hidden" id="gifBlock1">
            <img src="https://media.tenor.com/kDB-vGnoBmUAAAAj/bubu-dudu-excited.gif" alt="Bubu Dudu Excited GIF" loading="lazy" />
        </div>

        <p class="message content-block hidden" id="messageBlock1"></p>

        <div class="button-group content-block hidden" id="chapter1ButtonGroup">
            <button id="startJourneyBtn" class="btn hidden"><span>Begin Our Journey 💖</span></button>
        </div>

        <div id="loveMeter" class="content-block hidden">
            <p class="love-meter-title">Doofy’s Celestial Path of Affection</p>
            <div class="ribbon-container">
                <div class="shimmering-ribbon" id="loveProgressBar"></div>
                <div class="love-star-node" style="left: 0%;" data-level="0"></div>
                <div class="love-star-node" style="left: 25%;" data-level="25"></div>
                <div class="love-star-node" style="left: 50%;" data-level="50"></div>
                <div class="love-star-node" style="left: 75%;" data-level="75"></div>
                <div class="love-star-node" style="left: 100%;" data-level="100"></div>
            </div>
            <p id="loveStatusMessage" class="love-status-message">A tender whisper of budding affection. ✨ (Love: <span id="loveCount">0</span>%)</p>
        </div>

        <div class="gif-inline-container content-block hidden" id="gifBlock2">
            <img src="https://media.tenor.com/naYMunSvaa8AAAAj/eating-cake.gif" alt="Bubu Dudu Eating Cake GIF" loading="lazy" />
        </div>

        <div class="button-group content-block hidden" id="chapter2ButtonGroup">
            <button id="hugBtn" class="btn hidden"><span>Send a Gentle Embrace 🤗</span></button>
            <button id="complimentsBtn" class="btn hidden"><span>Offer a Thoughtful Compliment ✨</span></button>
        </div>

        <div class="content-section hidden" id="hugContentWrapper">
            <img id="hugGifDisplay" src="" alt="Hug GIF Display">
        </div>
        <div class="content-section hidden" id="complimentContentWrapper">
            <p class="message-display" id="complimentMessageDisplay"></p>
        </div>

        <div class="button-group content-block hidden" id="chapter3ButtonGroup">
            <button id="makeAWishBtn" class="btn hidden"><span>Make a Wish! 🌠</span></button>
        </div>

        <div class="content-section hidden" id="makeAWishContentWrapper">
            <p class="message-display" id="makeAWishMessage"></p>
        </div>

        <div class="button-group content-block hidden" id="chapter4ButtonGroup">
             <button id="whispersOfStarlightBtn" class="btn hidden"><span>Whispers of Starlight 💫</span></button>
        </div>

        <div class="button-group content-block hidden" id="finalChapterButtonGroup">
            <button id="finalMessageBtn" class="btn hidden disabled"><span>Unveil My Heart's True Message ❤️</span></button>
        </div>

        <footer>Always your devoted Doofy 🐾💖</footer>
    </main>

    <div id="confettiLayer"></div>
    <div class="wish-text-prompt hidden" id="wishPrompt">🌠 Make your wish... 🌠</div>
    <div id="meteorShowerContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 998;"></div>
    <div id="whispersContainer" style="position: fixed; inset: 0; pointer-events: none; z-index: 100;"></div>

    <div id="finalMessageOverlay" class="hidden">
        <div class="final-message-card">
            <h2>🌙 You're Someone I’m Grateful to Know</h2>
            <p>
                Quackers, today’s about you — and I just want to say thank you. <br><br>
                For being steady. For being kind. For being you. <br><br>
                I hope your day brings you calm moments, quiet joy, and a smile that sticks around longer than expected. <br><br>
                You make things softer and safer — and that means something. <br><br>
                Happy Birthday 💛<br>
                — Doofy 🐾
            </p>
            <button id="nextRealmBtn" class="btn"><span>Let's Go to the Next Realm ✨</span></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingTexts = [
                document.getElementById('loadingText1'),
                document.getElementById('loadingText2'),
                document.getElementById('loadingText3')
            ];
            let currentLoadingTextIndex = 0;

            const introPopup = document.getElementById('introPopup');
            const popupClickArea = document.getElementById('popupClickArea');
            const mainContent = document.getElementById('mainContent');
            const musicHint = document.getElementById('musicHint');

            const mainTitle = document.getElementById('mainTitle');
            const gifBlock1 = document.getElementById('gifBlock1');
            const messageBlock1 = document.getElementById('messageBlock1'); // Main story message
            const gifBlock2 = document.getElementById('gifBlock2');

            const startJourneyBtn = document.getElementById('startJourneyBtn');
            const hugBtn = document.getElementById('hugBtn');
            const complimentsBtn = document.getElementById('complimentsBtn');
            const makeAWishBtn = document.getElementById('makeAWishBtn');
            const whispersOfStarlightBtn = document.getElementById('whispersOfStarlightBtn');
            const finalMessageBtn = document.getElementById('finalMessageBtn');
            const nextRealmBtn = document.getElementById('nextRealmBtn'); // New button

            const chapter1ButtonGroup = document.getElementById('chapter1ButtonGroup');
            const chapter2ButtonGroup = document.getElementById('chapter2ButtonGroup');
            const chapter3ButtonGroup = document.getElementById('chapter3ButtonGroup');
            const chapter4ButtonGroup = document.getElementById('chapter4ButtonGroup');
            const finalChapterButtonGroup = document.getElementById('finalChapterButtonGroup');

            const hugContentWrapper = document.getElementById('hugContentWrapper');
            const hugGifDisplay = document.getElementById('hugGifDisplay');
            const complimentContentWrapper = document.getElementById('complimentContentWrapper');
            const complimentMessageDisplay = document.getElementById('complimentMessageDisplay');
            const makeAWishContentWrapper = document.getElementById('makeAWishContentWrapper');
            const makeAWishMessage = document.getElementById('makeAWishMessage');
            const wishPrompt = document.getElementById('wishPrompt');
            const finalMessageOverlay = document.getElementById('finalMessageOverlay');

            const loveCountSpan = document.getElementById('loveCount');
            const loveProgressBar = document.getElementById('loveProgressBar');
            const loveStatusMessage = document.getElementById('loveStatusMessage');
            const loveStarNodes = document.querySelectorAll('.love-star-node');
            const confettiLayer = document.getElementById('confettiLayer');
            const particleOverlay = document.getElementById('particle-overlay');
            const loveMeterElement = document.getElementById('loveMeter');
            const meteorShowerContainer = document.getElementById('meteorShowerContainer');
            const whispersContainer = document.getElementById('whispersContainer');

            const cometCursor = document.getElementById('cometCursor');

            const introMusic = document.getElementById('introMusic');
            const mainMusic = document.getElementById('mainMusic');

            // --- Data for Gifs, Compliments, and Messages ---
            const hugGifs = [
                "https://media.tenor.com/ScOwzW70wHIAAAAj/bubu.gif",
                "https://media.tenor.com/2bw-Zzp-mTMAAAAj/bear-hug.gif",
                "https://media.tenor.com/F2SQcVd5fMIAAAAj/hug-couple.gif",
                "https://media.tenor.com/vzkveVGDzmAAAAj/dudu-hug-bubu-dudu-kiss.gif",
                "https://media.tenor.com/fFpVFqD_4esAAAAj/peluk.gif",
                "https://media.tenor.com/RG_lIajbbtQAAAAj/milk-and-mocha.gif",
                "https://media.tenor.com/YfaICXGzuSoAAAAj/i-love-you-i-missed-you.gif"
            ];

            const compliments = [
                "You're a beacon of calm in a chaotic world. 🧘‍♀️",
                "Your kindness shines brighter than any star. ✨",
                "The quiet strength you possess is truly inspiring. 💪",
                "You bring a gentle warmth to every moment. 🔥",
                "Your presence is a comforting melody.🎶",
                "You have a heart of gold, pure and true.💛",
                "Simply being yourself makes the world a better place.🌍",
                "Your empathy is a rare and beautiful gift.🎁",
                "You're as refreshing as a cool breeze on a summer day.🌬️",
                "May your day be filled with as much joy as you give to others.😊"
            ];

            const whisperMessages = [
                "✨ Some people bring peace just by being there. You're one of them.",
                "💫 A gentle sparkle spell for the most respected person, echoing through the cosmos!",
                "🌌 Doofy's Aura of Calm activated — your peace is MAXED, a celestial blessing!",
                "⭐ Your quiet radiance outshines the softest dawn, a universe of brilliance!",
                "💖 Doofy's heart sends boundless affection, filling your cosmic space with joy!",
                "🌟 May tranquility descend upon you, a starlight blessing from Doofy's devotion!",
                "✨ A shower of pure, serene joy just for you, shimmering with Doofy's enchantment!"
            ];

            const mainStoryMessage = "Hey sweet Quackers! 🦆\n\nYour Doofy here, enveloping you in *gentle* embrace energy and warm smiles!\nJust like these adorable companions, I'm genuinely thrilled to celebrate the wonderful person you are today.\nYou’re the quiet strength in my life, the most comforting presence, and the sweetest reason to cherish every moment.\n\nMay this special day bring gentle laughter, tender solace, and a heart overflowing with quiet joy. 💕";
            const wishConfirmationMessage = "Your wish has soared into the cosmos, gathering stardust and dreams! ✨ May it manifest into the gentle joys you deserve.";

            // --- State Variables ---
            let loveCount = 0;
            const maxLove = 100;
            const loveMessages = {
                0: "A tender whisper of budding affection. ✨",
                10: "A soft glow of growing fondness, a new star igniting.",
                25: "Our cherished bond begins to gracefully unfold, like a nebula taking form.",
                50: "Our connection deepens, a quiet symphony of hearts, harmonizing with the cosmos.",
                75: "The profound affection within our bond strengthens, a galaxy expanding.",
                100: "🌕 Your presence fills this space with quiet joy. (Love: 100%)"
            };

            const confettiColors = ['#E0E0E0', '#B0B9C6', '#6B7280', '#ffcc33'];

            // Track if one-time events/interactions have occurred to prevent re-triggering love points
            let hugClicked = false;
            let complimentClicked = false;
            let wishMade = false;
            let starlightWhispered = false;


            // --- Core Functions ---

            /**
             * Implements a typewriter effect with glowing characters for specific elements.
             * Each character is wrapped in a span and animated individually.
             * This version is used for compliment and wish messages.
             * @param {HTMLElement} element - The DOM element to type into.
             * @param {string} text - The text content to type.
             * @param {number} charDelay - Delay between typing each character (in ms).
             * @param {function} callback - Function to call after the typing effect completes.
             */
            function typeWriterEffect(element, text, charDelay = 40, callback = () => {}) {
                element.innerHTML = ''; // Clear existing content

                const chars = text.split('');
                let totalSpans = 0;

                chars.forEach(char => {
                    if (char === '\n') {
                        element.appendChild(document.createElement('br')); // Explicit <br> for new lines
                    } else {
                        const span = document.createElement('span');
                        span.textContent = char === ' ' ? '\u00A0' : char; // Use non-breaking space for spaces
                        span.style.animation = `textFadeInGlow 0.9s forwards cubic-bezier(0.2, 0.8, 0.4, 1.2)`;
                        span.style.animationDelay = `${totalSpans * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--typewriter-char-delay'))}s`;
                        element.appendChild(span);
                        totalSpans++;
                    }
                });

                // Calculate total animation duration for callback timing
                const actualAnimatedChars = text.replace(/\n/g, '').length;
                const totalAnimationDuration = (actualAnimatedChars * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--typewriter-char-delay')) * 1000) + 900;

                setTimeout(() => {
                    callback();
                }, totalAnimationDuration);
            }

            /**
             * Updates the love meter progress bar and message.
             * Also triggers visual effects like aura and node lighting.
             * @param {number} amount - The amount to add to the love count.
             */
            function updateLoveMeter(amount) {
                loveCount = Math.min(maxLove, loveCount + amount);
                loveCountSpan.textContent = loveCount;
                loveProgressBar.style.width = `${loveCount}%`;

                // Update aura class based on love progress
                loveMeterElement.classList.remove('aura-level-1', 'aura-level-2', 'aura-level-3', 'aura-level-4');
                let auraClass = '';
                if (loveCount >= 25 && loveCount < 50) {
                    auraClass = 'aura-level-1';
                } else if (loveCount >= 50 && loveCount < 75) {
                    auraClass = 'aura-level-2';
                } else if (loveCount >= 75 && loveCount < 100) {
                    auraClass = 'aura-level-3';
                } else if (loveCount === 100) {
                    auraClass = 'aura-level-4';
                }
                if (auraClass) {
                     loveMeterElement.classList.add(auraClass);
                }

                // Light up love star nodes based on progress
                loveStarNodes.forEach(node => {
                    const level = parseInt(node.dataset.level);
                    if (loveCount >= level) {
                        node.classList.add('lit');
                    } else {
                        node.classList.remove('lit');
                    }
                });

                // Add shimmering effect to ribbon when love is increasing but not yet full
                if (amount > 0 && loveCount < 100) {
                    loveProgressBar.classList.add('active-shimmer');
                    createLoveDustSparkles(loveMeterElement);
                } else {
                    loveProgressBar.classList.remove('active-shimmer');
                }

                // Add pulsing effect to love meter when not full
                if (loveCount > 0 && loveCount < 100) {
                    loveMeterElement.classList.add('love-meter-pulsing');
                } else {
                    loveMeterElement.classList.remove('love-meter-pulsing');
                }

                // Update love status message
                let currentMessage = loveMessages[0];
                const sortedThresholds = Object.keys(loveMessages).map(Number).sort((a, b) => a - b);
                for (const threshold of sortedThresholds) {
                    if (loveCount >= threshold) {
                        currentMessage = loveMessages[threshold];
                    }
                }
                loveStatusMessage.textContent = loveCount === 100 ? loveMessages[100] : `🌼 Steady and soft, like your kindness. (Love: ${loveCount}%)`;

                if (loveCount > 0 && loveCount < 100 && amount > 0) triggerConfetti(15);
                
                if (loveCount >= 25 && chapter3ButtonGroup.classList.contains('hidden')) {
                    revealSection(chapter3ButtonGroup, 'button-group');
                }
                if (loveCount >= 50 && chapter4ButtonGroup.classList.contains('hidden')) {
                    revealSection(chapter4ButtonGroup, 'button-group');
                }

                checkFinalMessageUnlock();
            }

            /**
             * Creates small, temporary sparkle particles around a source element.
             * @param {HTMLElement} sourceElement - The element from which sparkles originate.
             */
            function createLoveDustSparkles(sourceElement) {
                const rect = sourceElement.getBoundingClientRect();
                const sparkleCount = 5;
                for (let i = 0; i < sparkleCount; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle';
                    sparkle.style.left = `${rect.left + rect.width / 2}px`;
                    sparkle.style.top = `${rect.top + rect.height / 2}px`;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    sparkle.style.animationDuration = `${Math.random() * 0.8 + 0.4}s`;
                    sparkle.style.width = `${Math.random() * 4 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.backgroundColor = 'var(--color-gold-light)';
                    sparkle.style.boxShadow = '0 0 10px var(--color-gold-glow)';
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }

            /**
             * Triggers a burst of confetti animation.
             * @param {number} count - Number of confetti pieces to generate.
             */
            function triggerConfetti(count = 30) {
                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = `${-10 - Math.random() * 20}vh`;
                    confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                    confetti.style.animationDelay = Math.random() * 0.6 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 4) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                    confettiLayer.appendChild(confetti);
                    confetti.addEventListener('animationend', () => confetti.remove());
                }
            }

            /**
             * Creates a single floating star animation.
             */
            function createFloatingStar() {
                const star = document.createElement('div');
                star.className = 'floating-star-hug';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.animationDuration = (Math.random() * 3 + 7) + 's';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.textContent = '⭐';
                document.body.appendChild(star);
                star.addEventListener('animationend', () => star.remove());
            }

            /**
             * Triggers the "Whispers of Starlight" visual effects.
             * @param {string} message - The message to display in the bubble.
             */
            function triggerWhispersOfStarlight(message) {
                document.body.classList.add('magic-aura-active');
                setTimeout(() => {
                    document.body.classList.remove('magic-aura-active');
                }, 3000);

                const particleCount = 40;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'whisper-starlight-particle';
                    const size = Math.random() * 3 + 1;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.animationDelay = `${Math.random() * 1.8}s`;
                    particle.style.animationDuration = `${Math.random() * 1.8 + 2.5}s`;
                    particle.style.setProperty('--end-x-offset', `${(Math.random() - 0.5) * 60}px`);
                    whispersContainer.appendChild(particle);
                    particle.addEventListener('animationend', () => particle.remove());
                }

                const messageBubble = document.createElement('div');
                messageBubble.className = 'whisper-message-bubble';
                messageBubble.textContent = message;
                whispersContainer.appendChild(messageBubble);
                messageBubble.addEventListener('animationend', () => messageBubble.remove());
            }

            /**
             * Hides all currently active content sections that are displayed by buttons.
             */
            function hideAllButtonContent() {
                document.querySelectorAll('.content-section').forEach(wrapper => {
                    if (wrapper.classList.contains('active')) {
                        wrapper.classList.remove('active');
                        wrapper.classList.add('hidden');
                        if (wrapper.id === 'complimentContentWrapper') {
                            wrapper.querySelector('.message-display').innerHTML = '';
                        } else if (wrapper.id === 'hugContentWrapper') {
                            wrapper.querySelector('#hugGifDisplay').src = '';
                        } else if (wrapper.id === 'makeAWishContentWrapper') {
                            wrapper.querySelector('#makeAWishMessage').innerHTML = '';
                        }
                    }
                });
            }

            /**
             * Triggers a meteor shower animation with screen shake, particle bursts, and wishing dust.
             * @param {number} count - Number of meteors to generate.
             * @param {number} duration - Total duration of the meteor shower in milliseconds.
             */
            function triggerMeteorShower(count = 70, duration = 6000) {
                document.body.classList.add('screen-shaking');
                wishPrompt.classList.remove('hidden');

                for (let i = 0; i < count; i++) {
                    const meteor = document.createElement('div');
                    meteor.className = 'meteor';

                    const startX = window.innerWidth * (0.8 + Math.random() * 0.4);
                    const startY = -window.innerHeight * (0.1 + Math.random() * 0.2);
                    const endX = -window.innerWidth * (0.2 + Math.random() * 0.4);
                    const endY = window.innerHeight * (1.1 + Math.random() * 0.2);

                    const size = Math.random() * 4 + 4;
                    meteor.style.width = `${size}px`;
                    meteor.style.height = `${size * 40}px`;

                    meteor.style.setProperty('--start-x', `${startX}px`);
                    meteor.style.setProperty('--start-y', `${startY}px`);
                    meteor.style.setProperty('--end-x', `${endX}px`);
                    meteor.style.setProperty('--end-y', `${endY}px`);

                    const animDuration = 4 + Math.random() * 3;
                    meteor.style.animation = `fall ${animDuration}s cubic-bezier(0.4, 0, 0.6, 1) forwards`;
                    meteor.style.animationDelay = `${Math.random() * (duration / 1000) * 0.8}s`;

                    meteorShowerContainer.appendChild(meteor);

                    meteor.addEventListener('animationend', () => {
                        const meteorRect = meteor.getBoundingClientRect();
                        if (meteorRect.right > -50 && meteorRect.bottom > -50 && meteorRect.left < window.innerWidth + 50 && meteorRect.top < window.innerHeight + 50) {
                             createBurst(meteorRect.right, meteorRect.bottom);
                             createWishingDust(meteorRect.right, meteorRect.bottom);
                        }
                        meteor.remove();
                    }, { once: true });
                }

                setTimeout(() => {
                    document.body.classList.remove('screen-shaking');
                    wishPrompt.classList.add('hidden');
                    createWishOrb();
                    typeWriterEffect(makeAWishMessage, wishConfirmationMessage, 40); // Still using typewriter for wish confirmation
                }, duration + 1000);
            }

            /**
             * Creates a burst of particles at a given location.
             * @param {number} x - X coordinate for the burst.
             * @param {number} y - Y coordinate for the burst.
             */
            function createBurst(x, y) {
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'burst-particle';
                    const angle = Math.random() * 2 * Math.PI;
                    const radius = Math.random() * 40;
                    const dx = Math.cos(angle) * radius;
                    const dy = Math.sin(angle) * radius;
                    particle.style.left = `${x + dx}px`;
                    particle.style.top = `${y + dy}px`;
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }
            }

            /**
             * Creates wishing dust particles that converge to a central point.
             * @param {number} x - X coordinate where dust originates.
             * @param {number} y - Y coordinate where dust originates.
             * @param {number} count - Number of dust particles.
             */
            function createWishingDust(x, y, count = 8) {
                const targetX = window.innerWidth / 2;
                const targetY = window.innerHeight * 0.8;
                for (let i = 0; i < count; i++) {
                    const dust = document.createElement('div');
                    dust.className = 'wishing-dust';
                    const size = Math.random() * 4 + 2;
                    dust.style.width = `${size}px`;
                    dust.style.height = `${size}px`;
                    dust.style.left = `${x + (Math.random() - 0.5) * 20}px`;
                    dust.style.top = `${y + (Math.random() - 0.5) * 20}px`;
                    dust.style.animationDelay = `${Math.random() * 0.2}s`;
                    dust.style.setProperty('--target-x', `${targetX - dust.getBoundingClientRect().left}px`);
                    dust.style.setProperty('--target-y', `${targetY - dust.getBoundingClientRect().top}px`);
                    document.body.appendChild(dust);
                    dust.addEventListener('animationend', () => dust.remove());
                }
            }

            /**
             * Creates a temporary wish orb animation.
             */
            function createWishOrb() {
                const orb = document.createElement('div');
                orb.className = 'wish-orb';
                document.body.appendChild(orb);
                orb.addEventListener('animationend', () => orb.remove());
            }

            /**
             * Sets up the parallax effect for background blobs based on scroll position.
             */
            function setupParallax() {
                const parallaxLayers = document.querySelectorAll('.background-blob');
                window.addEventListener('scroll', () => {
                    const scrollY = window.pageYOffset;
                    parallaxLayers.forEach(layer => {
                        const speed = parseFloat(layer.dataset.parallaxSpeed);
                        const transformY = -scrollY * speed * 0.1;
                        layer.style.transform = `translateY(${transformY}px)`;
                    });
                });
            }

            /**
             * Creates a specified number of twinkling background particles (stardust).
             * @param {number} count - Number of particles to create.
             */
            function createParticles(count) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle-overlay-item';
                    particle.style.width = `${Math.random() * 4 + 1}px`;
                    particle.style.height = particle.style.width;
                    particle.style.left = `${Math.random() * 100}vw`;
                    particle.style.top = `${Math.random() * 100}vh`;
                    particle.style.animationDelay = `${Math.random() * 15}s`;
                    particle.style.animationDuration = `${Math.random() * 7 + 10}s`;
                    particleOverlay.appendChild(particle);
                }
            }

            /**
             * Updates the position of the custom comet cursor to follow the mouse.
             */
            document.addEventListener("mousemove", (e) => {
                cometCursor.style.left = `${e.clientX}px`;
                cometCursor.style.top = `${e.clientY}px`;
                // Always ensure the comet cursor class is on the body for visibility
                if (!document.body.classList.contains('comet-active')) {
                    document.body.classList.add('comet-active');
                }
            });

            /**
             * Creates small sparkle particles around an element on hover.
             * @param {Event} event - The mouseenter event.
             */
            function createHoverSparkles(event) {
                const target = event.currentTarget;
                const rect = target.getBoundingClientRect();
                const numSparkles = 5;
                for (let i = 0; i < numSparkles; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'hover-sparkle';
                    sparkle.style.left = `${rect.left + Math.random() * rect.width}px`;
                    sparkle.style.top = `${rect.top + Math.random() * rect.height}px`;
                    sparkle.style.width = `${Math.random() * 3 + 2}px`;
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.animationDelay = `${Math.random() * 0.1}s`;
                    document.body.appendChild(sparkle);
                    sparkle.addEventListener('animationend', () => sparkle.remove());
                }
            }

            /**
             * Reveals a section of content with a smooth transition.
             * @param {HTMLElement} element - The DOM element to reveal.
             * @param {string} type - Type of element ('content-block' or 'button-group') for specific handling.
             * @param {number} delay - Delay before revealing the element (in ms).
             */
            function revealSection(element, type = 'content-block', delay = 0) {
                setTimeout(() => {
                    element.classList.remove('hidden');
                    element.classList.add('active');

                    if (type === 'button-group') {
                        element.querySelectorAll('.btn').forEach((btn, btnIndex) => {
                            setTimeout(() => {
                                btn.classList.remove('hidden');
                                btn.classList.add('active');
                            }, btnIndex * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stagger-unit')) * 1000);
                        });
                    }
                }, delay);
            }

            /**
             * Hides a section of content with a smooth transition.
             * @param {HTMLElement} element - The DOM element to hide.
             */
            function hideSection(element) {
                element.classList.remove('active');
                element.classList.add('hidden');
            }

            /**
             * Hides relevant elements before a major effect and shows them after.
             * @param {function} effectFn - The function that triggers the main effect.
             * @param {number} effectDuration - Expected duration of the effect in ms.
             * @param {function} callbackAfterEffect - Function to run immediately after the effectFn finishes its animations.
             */
            function manageContentVisibilityForEffect(effectFn, effectDuration, callbackAfterEffect = () => {}) {
                // Elements to temporarily hide
                const elementsToHide = [
                    chapter2ButtonGroup,
                    loveMeterElement,
                    gifBlock2,
                    hugContentWrapper,
                    complimentContentWrapper,
                    makeAWishContentWrapper, // Hide if it was already showing confirmation
                    musicHint // Temporarily hide music hint
                ];

                elementsToHide.forEach(el => hideSection(el));

                // Wait for hide transitions to complete (adjust delay if needed)
                setTimeout(() => {
                    effectFn(); // Trigger the main effect
                    
                    // After the effect duration, reveal elements and call callback
                    setTimeout(() => {
                        elementsToHide.forEach(el => revealSection(el));
                        if (makeAWishMessage.textContent.trim() !== "") { // If wish confirmation was shown, reveal its wrapper
                            revealSection(makeAWishContentWrapper, 'content-section');
                        }
                        callbackAfterEffect();
                    }, effectDuration); // Wait for the effect to finish
                }, 700); // Allow time for hide transition
            }


            /**
             * Checks if all conditions are met to unlock the final message button.
             */
            function checkFinalMessageUnlock() {
                if (hugClicked && complimentClicked && wishMade && starlightWhispered) {
                    if (loveCount < 100) {
                        loveCount = 100;
                        updateLoveMeter(0); // Update to 100% if not already
                    }

                    if (finalMessageBtn.classList.contains('disabled')) {
                        finalMessageBtn.classList.remove('disabled');
                        if (finalChapterButtonGroup.classList.contains('hidden')) {
                            revealSection(finalChapterButtonGroup, 'button-group');
                        }
                    }
                }
            }

            /**
             * Manages the loading screen's storytelling text sequence.
             */
            function startLoadingStorytelling() {
                function showNextLoadingText() {
                    if (currentLoadingTextIndex < loadingTexts.length) {
                        const currentText = loadingTexts[currentLoadingTextIndex];
                        currentText.classList.add('active-text');
                        currentText.addEventListener('animationend', () => {
                            currentText.classList.remove('active-text');
                            currentLoadingTextIndex++;
                            showNextLoadingText();
                        }, { once : true });
                    } else {
                        setTimeout(() => {
                            loadingOverlay.classList.remove('active');
                            loadingOverlay.classList.add('hidden');
                            loadingOverlay.addEventListener('transitionend', () => {
                                loadingOverlay.remove();
                            }, { once: true });
                            revealSection(introPopup, 'popup');
                            introMusic.play().catch(e => console.log("Intro music playback prevented:", e));
                        }, 500);
                    }
                }
                showNextLoadingText();
            }


            // --- Event Listeners ---

            // Start loading storytelling once the window is fully loaded
            window.addEventListener('load', () => {
                startLoadingStorytelling();
            });

            // Handle click on the intro popup to reveal main content
            popupClickArea.addEventListener('click', () => {
                introPopup.classList.remove('active');
                introPopup.classList.add('hidden');
                introMusic.pause();
                introMusic.currentTime = 0; // Reset to start

                mainMusic.play().catch(e => console.log("Main music playback prevented:", e));


                introPopup.addEventListener('transitionend', () => {
                    introPopup.style.display = 'none';

                    // Set the main story message text directly
                    messageBlock1.textContent = mainStoryMessage;

                    // Reveal main content elements sequentially with delays
                    revealSection(mainContent, 'content');
                    revealSection(mainTitle, 'content-block', 300);
                    revealSection(musicHint, 'content-block', 600); // Reveal music hint
                    revealSection(gifBlock1, 'content-block', 900);
                    revealSection(messageBlock1.closest('.content-block'), 'content-block', 1200); // Reveal with pop-out effect
                    setTimeout(() => {
                        revealSection(chapter1ButtonGroup, 'button-group');
                    }, 1800); // Delay button group appearance slightly after message

                    // Start background sparkles after a delay
                    setTimeout(() => {
                        for(let i = 0; i < 40; i++) {
                            const s = document.createElement('div');
                            s.className = 'sparkle';
                            s.style.left = Math.random() * 100 + 'vw';
                            s.style.top = Math.random() * 100 + 'vh';
                            s.style.animationDelay = Math.random() * 8 + 's';
                            document.body.appendChild(s);
                        }
                    }, 1000);
                }, { once : true }); // Ensure this only runs once
            });

            // Handle "Begin Our Journey" button click
            startJourneyBtn.addEventListener('click', () => {
                startJourneyBtn.classList.remove('active');
                startJourneyBtn.classList.add('hidden');
                chapter1ButtonGroup.classList.remove('active');
                chapter1ButtonGroup.classList.add('hidden');

                setTimeout(() => {
                    revealSection(loveMeterElement, 'content-block');
                }, 500);

                setTimeout(() => {
                    revealSection(gifBlock2, 'content-block');
                }, 1000);

                setTimeout(() => {
                    revealSection(chapter2ButtonGroup, 'button-group');
                }, 1500);
            });

            // Handle "Send a Gentle Embrace" button click
            hugBtn.addEventListener('click', () => {
                hideAllButtonContent(); 
                
                const randomGif = hugGifs[Math.floor(Math.random() * hugGifs.length)];
                hugGifDisplay.src = randomGif;
                revealSection(hugContentWrapper, 'content-section');
                
                if (!hugClicked) {
                    hugClicked = true;
                    updateLoveMeter(10);
                }
                for(let i = 0; i < 5; i++) createFloatingStar();
            });

            // Handle "Offer a Thoughtful Compliment" button click
            complimentsBtn.addEventListener('click', () => {
                hideAllButtonContent();
                
                revealSection(complimentContentWrapper, 'content-section');

                const randomCompliment = compliments[Math.floor(Math.random() * compliments.length)];
                typeWriterEffect(complimentMessageDisplay, randomCompliment, 40, () => {
                    if (!complimentClicked) {
                        complimentClicked = true;
                        updateLoveMeter(15);
                    }
                });
            });

            // Handle "Make a Wish!" button click
            makeAWishBtn.addEventListener('click', () => {
                if (wishMade) {
                    console.log("Wish already made!");
                    return;
                }
                
                // Scroll to messageBlock1 immediately
                messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'start' });

                manageContentVisibilityForEffect(
                    () => { // Function to execute the effect
                        triggerMeteorShower(70, 5000); // Meteor shower duration is 5000ms + 1000ms for text = 6000ms total before callback.
                    },
                    6500, // Total duration including the message typing
                    () => { // Callback after effect
                        revealSection(makeAWishContentWrapper, 'content-section'); // Reveal the wish confirmation message
                        wishMade = true;
                        makeAWishBtn.classList.add('disabled');
                        updateLoveMeter(25);
                    }
                );
            });

            // Handle "Whispers of Starlight" button click
            whispersOfStarlightBtn.addEventListener('click', () => {
                if (starlightWhispered) {
                    console.log("Starlight already whispered!");
                    return;
                }
                
                // Scroll to messageBlock1 immediately
                messageBlock1.scrollIntoView({ behavior: 'smooth', block: 'start' });

                manageContentVisibilityForEffect(
                    () => { // Function to execute the effect
                        const randomMessage = whisperMessages[Math.floor(Math.random() * whisperMessages.length)];
                        triggerWhispersOfStarlight(randomMessage);
                    },
                    4500, // Duration of the whisper message bubble animation
                    () => { // Callback after effect
                        starlightWhispered = true;
                        whispersOfStarlightBtn.classList.add('disabled');
                        triggerConfetti(30);
                        updateLoveMeter(30);
                    }
                );
            });

            // Handle "Unveil My Heart's True Message" button click
            finalMessageBtn.addEventListener('click', () => {
                mainContent.classList.remove('active');
                mainContent.classList.add('hidden');
                
                // Ensure scroll is at the top when transitioning to final overlay
                window.scrollTo({
                    top: 0,
                    behavior: 'instant' // Use 'instant' to avoid a jarring scroll *before* the overlay appears
                });

                mainContent.addEventListener('transitionend', () => {
                    finalMessageOverlay.classList.remove('hidden');
                    finalMessageOverlay.classList.add('active');
                    mainMusic.pause(); // Pause main music on final page
                    mainMusic.currentTime = 0;
                    // Ensure the comet cursor remains active on the final overlay
                    document.body.classList.add('comet-active'); // Keep comet active on final page
                }, { once: true });
            });

            // Handle "Let's Go to the Next Realm" button click
            nextRealmBtn.addEventListener('click', () => {
                window.location.href = 'netflix.html'; // Redirect to netflix.html
            });


            // --- Hover Effects ---
            const elementsWithHoverSparkles = [mainTitle, messageBlock1, loveMeterElement];
            elementsWithHoverSparkles.forEach(el => {
                el.addEventListener('mouseenter', createHoverSparkles);
            });
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('mouseenter', createHoverSparkles);
            });


            // --- Initial Setup Calls ---
            setupParallax();
            createParticles(60);
            updateLoveMeter(0); // Initialize love meter
        });
    </script>
</body>
</html>
